<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>소설 집필 프로그램</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script>
        /* --- Google Drive API 설정 --- */
        const GOOGLE_API_KEY = 'AIzaSyDwkLPHCcuwfULdakJu2zFRBmWRBV6c7_M'; // API 키
        const GOOGLE_CLIENT_ID = '1068512138562-1mkelsqf0ph0f4at9f2po780cvt47o3t.apps.googleusercontent.com'; // OAuth 2.0 클라이언트 ID
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        let gapiInited = false;
        let tokenClient;

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }
        async function initializeGapiClient() {
            await gapi.client.init({ apiKey: GOOGLE_API_KEY, discoveryDocs: DISCOVERY_DOCS });
            gapiInited = true;
        }
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
        }
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #121212; color: #e0e0e0; overflow-x: hidden; }
        .bg-main { background-color: #121212; } .bg-surface { background-color: #1e1e1e; } .bg-card { background-color: #2a2a2a; } .border-main { border-color: #3f3f46; } .accent { color: #bb86fc; } .accent-bg { background-color: #bb86fc; } .accent-hover:hover { background-color: #a763ff; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #1e1e1e; } ::-webkit-scrollbar-thumb { background: #424242; border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: #5a5a5a; }
        .project-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; } .project-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15); }
        .list-item.active { background-color: #37373d; } .list-item:not(.active):hover { background-color: #2a2a2a; } .list-item .action-btn { visibility: hidden; opacity: 0; transition: opacity 0.2s; } .list-item:hover .action-btn { visibility: visible; opacity: 1; }
        .dragging { opacity: 0.5; background-color: #37373d; }
        .drag-over-item { border-top: 2px solid #bb86fc; }
        .drag-over-folder { background-color: #3a3a4a !important; box-shadow: 0 0 0 2px #bb86fc; }
        .tab-btn.active { background-color: #37373d; }
        .list-item-folder { background-color: #252525; font-weight: 500; } .list-item-chapter.in-folder { padding-left: 2rem !important; } .folder-children { max-height: 1000px; transition: max-height 0.3s ease-in-out; overflow: hidden; } .folder-children.collapsed { max-height: 0; }
        .folder-toggle { transition: transform 0.2s; } .folder-toggle.collapsed { transform: rotate(-90deg); }
        #editor-container { position: relative; overflow-x: hidden; } #editor-sidebar { width: 224px; position: absolute; top: 0; left: 0; height: 100%; z-index: 40; transform: translateX(-100%); transition: transform 0.3s ease-in-out; will-change: transform; } #editor-main-content { flex: 1; transition: padding-left 0.3s ease-in-out; padding-left: 0; }
        #editor-container.sidebar-open #editor-sidebar { transform: translateX(0); } #mobile-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 30; transition: opacity 0.3s ease-in-out; }
        #editor-sidebar-toggle { position: fixed; top: 50%; left: 0; transform: translateY(-50%); z-index: 50; width: 24px; height: 48px; display: flex; align-items: center; justify-content: center; transition: transform 0.3s ease-in-out; border-radius: 0 8px 8px 0; }
        #editor-container.sidebar-open #editor-sidebar-toggle { transform: translate(224px, -50%); }
        .character-image-container { background-color: #1e1e1e; background-size: cover; background-position: center; }
        .character-image-overlay { transition: opacity 0.2s; }
        @media (max-width: 767px) { #editor-container.sidebar-open #editor-main-content { padding-left: 0 !important; } }
        @media (min-width: 768px) { #editor-container.sidebar-open #editor-main-content { padding-left: 224px; } }
    </style>
</head>
<body class="bg-main antialiased">
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div id="loading-content" class="text-center text-white">
            <svg class="animate-spin h-10 w-10 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="text-lg">인증 정보를 확인하는 중입니다...</p>
        </div>
    </div>
    <div id="app-container" class="h-screen w-screen"></div>

    <!-- TEMPLATES -->
    <template id="login-view-template"><!-- unchanged --></template>
    <template id="home-view-template"><!-- unchanged --></template>
    <template id="editor-view-template"><!-- unchanged --></template>
    <template id="editor-panel-template"><!-- unchanged --></template>
    <template id="character-editor-panel-template"><!-- unchanged --></template>
    <template id="modal-template"><!-- unchanged --></template>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script>
    function showModal(options) { /* ... unchanged ... */ }
    function closeModal() { /* ... unchanged ... */ }

    document.addEventListener('DOMContentLoaded', () => {
        const appContainer = document.getElementById('app-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingContent = document.getElementById('loading-content');

        let db, auth, storage;
        let currentUserId = null;
        let currentUser = null;
        let unsubscribes = {};
        
        let projects = [];
        let chapters = [];
        let characters = [];

        let activeProjectId = null;
        let activeItemId = null;
        let sidebarMode = 'chapters';
        let charCountMode = 'noSpecialChars';
        let saveTimeouts = {};
        let collapsedFolders = new Set();

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify({
            apiKey: "AIzaSyDuXjdB4DuP2NFF_OeS6nEwhMu_7wGdDs4",
            authDomain: "novel-8d4ec.firebaseapp.com",
            projectId: "novel-8d4ec",
            storageBucket: "novel-8d4ec.appspot.com",
            messagingSenderId: "836560106988",
            appId: "1:836560106988:web:cf90872d7b09b9498ffcc9",
            measurementId: "G-83BZ35QVLC"
        });
        
        function initialize() {
            try {
                const firebaseConfig = JSON.parse(firebaseConfigStr);
                if (!firebaseConfig.projectId) throw new Error("'projectId'가 Firebase 설정에 없습니다.");
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                storage = firebase.storage();
                setupAuthListener();
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                loadingContent.innerHTML = `<div class="text-center text-red-400"><p class="text-lg font-bold">초기화 오류</p><p class="text-sm">${error.message}</p></div>`;
            }
        }

        // FIXED: Added a robust try-catch block to ensure the loading overlay is always handled.
        function setupAuthListener() {
            auth.onAuthStateChanged(user => {
                try {
                    currentUser = user;
                    if (user) {
                        currentUserId = user.uid;
                        renderView('home');
                        loadProjects();
                    } else {
                        currentUserId = null;
                        projects = [];
                        Object.values(unsubscribes).forEach(unsub => {
                            if (typeof unsub === 'function') unsub();
                        });
                        unsubscribes = {};
                        renderView('login');
                    }
                } catch (error) {
                    console.error("Error during auth state change:", error);
                    loadingContent.innerHTML = `<div class="text-center text-red-400"><p class="text-lg font-bold">앱 시작 오류</p><p class="text-sm">${error.message}</p></div>`;
                    // Do not hide the overlay if there's a critical error
                    return; 
                }
                loadingOverlay.style.display = 'none';
            });
        }

        // --- Data Loading & State ---
        function getProject(projectId) { return projects.find(p => p.id === projectId); }
        function getItem(itemId) {
            const items = sidebarMode === 'chapters' ? chapters : characters;
            return items.find(i => i.id === itemId);
        }

        function loadProjects() {
            if (!currentUserId) return;
            // FIXED: Removed .orderBy() to prevent index-related errors on initial load. Sorting is now done on the client.
            const projectsRef = db.collection(`artifacts/${appId}/users/${currentUserId}/projects`);
            
            unsubscribes.projects = projectsRef.onSnapshot(snapshot => {
                let projectList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // ADDED: Client-side sorting
                projectList.sort((a, b) => (b.lastModified?.toMillis() || 0) - (a.lastModified?.toMillis() || 0));
                projects = projectList;
                renderProjectGrid(); 
            }, error => {
                console.error("Project Loading Error:", error);
                const placeholder = appContainer.querySelector('#no-projects-placeholder');
                if(placeholder) {
                    placeholder.innerHTML = `<h3 class="text-xl font-semibold text-red-400">데이터 로딩 오류</h3><p class="text-gray-500 mt-2">프로젝트를 불러오지 못했습니다. Firestore 규칙을 확인해주세요.</p>`;
                    placeholder.classList.remove('hidden');
                }
            });
        }

        function loadItems() {
            if (unsubscribes.items) unsubscribes.items();
            const itemsRef = db.collection(`artifacts/${appId}/users/${currentUserId}/projects/${activeProjectId}/${sidebarMode}`);
            const q = itemsRef.orderBy(sidebarMode === 'chapters' ? 'order' : 'createdAt', 'asc');
            
            unsubscribes.items = q.onSnapshot(snapshot => {
                const itemList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (sidebarMode === 'chapters') {
                    chapters = itemList;
                } else {
                    characters = itemList;
                }
                renderItemList();
            });
        }

        // --- View Rendering & Listeners ---
        function renderView(viewName) {
            const template = document.getElementById(`${viewName}-view-template`);
            if (!template) return;
            appContainer.innerHTML = '';
            appContainer.appendChild(template.content.cloneNode(true));
            
            if (viewName === 'home') renderHome();
            else if (viewName === 'editor') renderEditor();
        }

        function renderHome() {
            const userProfileArea = appContainer.querySelector('#user-profile-area');
            if (currentUser) {
                userProfileArea.innerHTML = `
                    <div class="text-right">
                        <span class="font-semibold text-sm hidden sm:inline">${currentUser.displayName || '사용자'}</span>
                        <p class="text-xs text-gray-400 hidden sm:block truncate">${currentUser.email || '이메일 정보 없음'}</p>
                    </div>
                    <img class="w-10 h-10 rounded-full" src="${currentUser.photoURL || 'https://placehold.co/40x40/2a2a2a/e0e0e0?text=?'}" alt="Profile">
                    <button id="logout-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors">로그아웃</button>
                `;
            }
            renderProjectGrid();
        }

        function renderProjectGrid() {
            const projectGrid = appContainer.querySelector('#project-grid');
            const placeholder = appContainer.querySelector('#no-projects-placeholder');
            if (!projectGrid || !placeholder) return; 

            if (projects.length === 0) {
                projectGrid.innerHTML = '';
                projectGrid.classList.add('hidden');
                placeholder.classList.remove('hidden');
            } else {
                projectGrid.classList.remove('hidden');
                placeholder.classList.add('hidden');
                projectGrid.innerHTML = '';
                projects.forEach(project => projectGrid.appendChild(createProjectCard(project)));
            }
        }

        function createProjectCard(project) { /* ... unchanged ... */ }
        function renderEditor() { /* ... unchanged ... */ }
        function renderItemList() { /* ... unchanged ... */ }
        function buildItemTree(list) { /* ... unchanged ... */ }
        function createItemElement(item) { /* ... unchanged ... */ }
        function renderEditorPanel() { /* ... unchanged ... */ }
        function setupChapterPanelListeners(panel) { /* ... unchanged ... */ }
        function setupCharacterPanelListeners(panel) { /* ... unchanged ... */ }
        function updateSidebarUI() { /* ... unchanged ... */ }
        function updateCharCount() { /* ... unchanged ... */ }
        function toggleSidebar(forceOpen) { /* ... unchanged ... */ }
        function updateSidebarVisuals() { /* ... unchanged ... */ }
        
        // --- Handlers ---
        function handleGoogleLogin() { /* ... unchanged ... */ }
        function handleLogout() { /* ... unchanged ... */ }
        function handleNewProject() { /* ... unchanged ... */ }
        function handleProjectOptions(projectId) { /* ... unchanged ... */ }
        function handleRenameProject(projectId) { /* ... unchanged ... */ }
        function handleDeleteProject(projectId) { /* ... unchanged ... */ }
        function handleNewItem(type, parentId = null) { /* ... unchanged ... */ }
        function handleDeleteItem(itemId) { /* ... unchanged ... */ }
        function handleRenameItem(itemId) { /* ... unchanged ... */ }
        function handleEditorInput(e) { /* ... unchanged ... */ }
        function saveCurrentWork() { /* ... unchanged ... */ }
        function handleCopyContent() { /* ... unchanged ... */ }
        function handleSaveTxt() { /* ... unchanged ... */ }
        async function handleSaveToDrive() { /* ... unchanged ... */ }
        function addDragAndDropListeners(listEl) { /* ... unchanged ... */ }
        function handleImageUpload(e) { /* ... unchanged ... */ }

        // --- Central Event Handler ---
        appContainer.addEventListener('click', (e) => {
            const target = e.target;
            const closest = (selector) => target.closest(selector);

            // Login
            if (closest('#google-login-btn')) return handleGoogleLogin();

            // Home
            if (closest('#new-project-btn')) return handleNewProject();
            if (closest('#logout-btn')) return handleLogout();
            const projectCard = closest('.project-card');
            if (projectCard) {
                const optionsBtn = closest('[data-action="options"]');
                if (optionsBtn) {
                    e.stopPropagation();
                    return handleProjectOptions(projectCard.dataset.projectId);
                }
                activeProjectId = projectCard.dataset.projectId;
                sidebarMode = 'chapters';
                activeItemId = null;
                if (unsubscribes.items) unsubscribes.items();
                renderView('editor');
                loadItems();
                return;
            }

            // Editor
            if (closest('#home-btn')) return renderView('home');
            if (closest('#editor-sidebar-toggle')) return toggleSidebar();
            if (closest('#mobile-overlay')) return toggleSidebar(false);
            
            if (closest('#new-item-btn')) return handleNewItem(sidebarMode === 'chapters' ? 'chapter' : 'character');
            if (closest('#new-folder-btn')) return handleNewItem('folder');

            const tabBtn = closest('.tab-btn');
            if (tabBtn) {
                sidebarMode = tabBtn.dataset.tab;
                activeItemId = null;
                updateSidebarUI();
                loadItems();
                renderEditorPanel();
                return;
            }

            const itemEl = closest('.list-item');
            if (itemEl) {
                if (closest('[data-action="toggle-folder"]')) {
                    const folderId = itemEl.dataset.id;
                    if (collapsedFolders.has(folderId)) collapsedFolders.delete(folderId);
                    else collapsedFolders.add(folderId);
                    renderItemList();
                } else if (closest('[data-action="delete-item"]')) {
                    handleDeleteItem(itemEl.dataset.id);
                } else if (closest('[data-action="rename-item"]')) {
                    handleRenameItem(itemEl.dataset.id);
                } else {
                    activeItemId = itemEl.dataset.id;
                    if (window.innerWidth < 768) toggleSidebar(false);
                    renderItemList();
                    renderEditorPanel();
                }
                return;
            }

            // Editor Panel
            if (closest('#copy-content-btn')) return handleCopyContent();
            if (closest('#save-drive-btn')) return handleSaveToDrive();
            if (closest('#save-txt-btn')) return handleSaveTxt();
            if (closest('#char-count-container')) {
                charCountMode = charCountMode === 'noSpecialChars' ? 'noSpaces' : 'noSpecialChars';
                updateCharCount();
                return;
            }
            if (closest('#character-image-container')) {
                appContainer.querySelector('#image-upload-input')?.click();
                return;
            }
        });

        appContainer.addEventListener('input', e => {
            if (e.target.closest('#editor-title, #editor-content, #character-name, #character-personality, #character-appearance, #character-characteristics')) {
                handleEditorInput(e);
            }
        });
        appContainer.addEventListener('change', e => {
            if (e.target.closest('#image-upload-input')) {
                handleImageUpload(e);
            }
        });

        initialize();
    });
    </script>
    <script async defer src="https://accounts.google.com/js/api.js" onload="gapiLoaded()"></script>
</body>
</html>
