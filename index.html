<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>소설 집필 프로그램</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script>
        /* --- Google Drive API 설정 --- */
        const GOOGLE_API_KEY = 'AIzaSyDwkLPHCcuwfULdakJu2zFRBmWRBV6c7_M'; // API 키
        const GOOGLE_CLIENT_ID = '1068512138562-1mkelsqf0ph0f4at9f2po780cvt47o3t.apps.googleusercontent.com'; // OAuth 2.0 클라이언트 ID
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        let gapiInited = false;
        let tokenClient;

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }
        async function initializeGapiClient() {
            await gapi.client.init({ apiKey: GOOGLE_API_KEY, discoveryDocs: DISCOVERY_DOCS });
            gapiInited = true;
        }
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
        }
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #121212; color: #e0e0e0; overflow-x: hidden; }
        .bg-main { background-color: #121212; } .bg-surface { background-color: #1e1e1e; } .bg-card { background-color: #2a2a2a; } .border-main { border-color: #3f3f46; } .accent { color: #bb86fc; } .accent-bg { background-color: #bb86fc; } .accent-hover:hover { background-color: #a763ff; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #1e1e1e; } ::-webkit-scrollbar-thumb { background: #424242; border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: #5a5a5a; }
        .project-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; } .project-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15); }
        .list-item.active { background-color: #37373d; } .list-item:not(.active):hover { background-color: #2a2a2a; } .list-item .delete-btn { visibility: hidden; opacity: 0; transition: opacity 0.2s; } .list-item:hover .delete-btn { visibility: visible; opacity: 1; }
        .dragging { opacity: 0.5; } .drag-over { border-top: 2px solid #bb86fc; } .tab-btn.active { background-color: #37373d; }
        .list-item-folder { background-color: #252525; font-weight: 500; } .list-item-chapter.in-folder { padding-left: 2rem !important; } .folder-children { max-height: 1000px; transition: max-height 0.3s ease-in-out; overflow: hidden; } .folder-children.collapsed { max-height: 0; }
        .folder-toggle { transition: transform 0.2s; } .folder-toggle.collapsed { transform: rotate(-90deg); }
        #editor-container { position: relative; overflow-x: hidden; } #editor-sidebar { width: 224px; position: absolute; top: 0; left: 0; height: 100%; z-index: 40; transform: translateX(-100%); transition: transform 0.3s ease-in-out; will-change: transform; } #editor-main-content { flex: 1; transition: padding-left 0.3s ease-in-out; padding-left: 0; }
        #editor-container.sidebar-open #editor-sidebar { transform: translateX(0); } #mobile-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 30; transition: opacity 0.3s ease-in-out; }
        #editor-sidebar-toggle { position: fixed; top: 50%; left: 0; transform: translateY(-50%); z-index: 50; width: 24px; height: 48px; display: flex; align-items: center; justify-content: center; transition: transform 0.3s ease-in-out; border-radius: 0 8px 8px 0; }
        #editor-container.sidebar-open #editor-sidebar-toggle { transform: translate(224px, -50%); }
        @media (max-width: 767px) { #editor-container.sidebar-open #editor-main-content { padding-left: 0 !important; } }
        @media (min-width: 768px) { #editor-container.sidebar-open #editor-main-content { padding-left: 224px; } }
    </style>
</head>
<body class="bg-main antialiased">
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div id="loading-content" class="text-center text-white">
            <svg class="animate-spin h-10 w-10 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="text-lg">데이터를 불러오는 중입니다...</p>
        </div>
    </div>
    <div id="app-container" class="h-screen w-screen"></div>

    <template id="login-view-template"></template>
    <template id="home-view-template">
        <div class="p-4 sm:p-6 md:p-8 flex flex-col h-full">
            <header class="flex justify-between items-center mb-8"></header>
            <main class="flex-grow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">최근 편집</h2>
                    <button id="new-project-btn" class="accent-bg accent-hover text-black font-bold py-2 px-5 rounded-lg transition-colors">+ 새 프로젝트</button>
                </div>
                <div id="project-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>
                <div id="no-projects-placeholder" class="hidden text-center py-16">
                    <h3 class="text-xl font-semibold text-gray-400">아직 작업이 없네요.</h3>
                    <p class="text-gray-500 mt-2">새 프로젝트를 만들어 당신의 이야기를 시작해보세요!</p>
                </div>
            </main>
        </div>
    </template>
    <template id="editor-view-template"></template>
    <template id="editor-panel-template"></template>
    <template id="modal-template"></template>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
    // Global utilities
    function showModal(options) { /* ... unchanged ... */ }
    function closeModal() { /* ... unchanged ... */ }

    document.addEventListener('DOMContentLoaded', () => {
        const appContainer = document.getElementById('app-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingContent = document.getElementById('loading-content');

        let db, auth;
        let currentUserId = null;
        let currentUser = null;
        let unsubscribes = {};
        
        let projects = [];
        let chapters = [];
        let characters = [];

        let activeProjectId = null;
        let activeItemId = null;
        let sidebarMode = 'chapters';
        let charCountMode = 'noSpecialChars';
        let saveTimeouts = {};
        let autoSaveInterval = null;
        let collapsedFolders = new Set();

        const firebaseConfig = { /* ... unchanged ... */ };
        
        function initialize() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                setupAuthListener();
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                loadingContent.innerHTML = `<div class="text-center text-red-400"><p class="text-lg font-bold">초기화 오류</p><p class="text-sm">${error.message}</p></div>`;
            }
        }

        function setupAuthListener() {
            auth.onAuthStateChanged(user => {
                currentUser = user;
                if (user) {
                    currentUserId = user.uid;
                    loadProjects();
                } else {
                    currentUserId = null;
                    projects = [];
                    Object.values(unsubscribes).forEach(unsub => unsub());
                    unsubscribes = {};
                    renderView('login');
                    loadingOverlay.style.display = 'none';
                }
            });
        }

        // --- Data Loading ---
        function loadProjects() {
            if (!currentUserId) return;
            const projectsRef = db.collection(`users/${currentUserId}/projects`).orderBy('lastModified', 'desc');
            
            unsubscribes.projects = projectsRef.onSnapshot(snapshot => {
                projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // FIXED: Check if the current view is home or not set yet before rendering
                // This prevents re-rendering the home view when in the editor.
                if (!appContainer.querySelector('#editor-container')) {
                    renderView('home');
                }
                loadingOverlay.style.display = 'none';
            }, error => {
                console.error("Project Loading Error:", error);
                loadingContent.innerHTML = `<div class="text-center text-red-400"><p class="text-lg font-bold">데이터 로딩 오류</p><p class="text-sm">데이터를 불러오는 데 실패했습니다. Firestore 규칙(Rules)이나 색인(Index) 설정을 확인해주세요.</p><p class="text-xs mt-2 text-gray-500">Error: ${error.message}</p></div>`;
            });
        }

        function loadItems() {
            if (unsubscribes.items) unsubscribes.items();
            const itemsRef = db.collection(`users/${currentUserId}/projects/${activeProjectId}/${sidebarMode}`);
            const q = itemsRef.orderBy(sidebarMode === 'chapters' ? 'order' : 'createdAt', 'asc');
            
            unsubscribes.items = q.onSnapshot(snapshot => {
                const itemList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (sidebarMode === 'chapters') {
                    chapters = itemList;
                } else {
                    characters = itemList;
                }
                // OPTIMIZED: Render only the item list, not the whole view
                renderItemList();
            });
        }

        // --- View Rendering & Listeners ---
        function renderView(viewName, data = {}) {
            const template = document.getElementById(`${viewName}-view-template`);
            if (!template) return;
            appContainer.innerHTML = '';
            appContainer.appendChild(template.content.cloneNode(true));
            
            if (autoSaveInterval) clearInterval(autoSaveInterval);
            
            // OPTIMIZED: Attach listeners specific to the rendered view
            if (viewName === 'login') setupLoginListeners();
            else if (viewName === 'home') renderHome();
            else if (viewName === 'editor') renderEditor();
        }

        function setupLoginListeners() {
            appContainer.querySelector('#google-login-btn')?.addEventListener('click', handleGoogleLogin);
        }

        function renderHome() {
            // ... (user profile rendering logic is the same)
            const projectGrid = appContainer.querySelector('#project-grid');
            const placeholder = appContainer.querySelector('#no-projects-placeholder');
            
            // FIXED: Handle case where there are no projects
            if (projects.length === 0) {
                projectGrid.classList.add('hidden');
                placeholder.classList.remove('hidden');
            } else {
                projectGrid.classList.remove('hidden');
                placeholder.classList.add('hidden');
                projectGrid.innerHTML = '';
                projects.forEach(project => projectGrid.appendChild(createProjectCard(project)));
            }
            setupHomeListeners();
        }

        function setupHomeListeners() {
            appContainer.querySelector('#new-project-btn')?.addEventListener('click', handleNewProject);
            appContainer.querySelector('#logout-btn')?.addEventListener('click', handleLogout);
            appContainer.querySelector('#project-grid')?.addEventListener('click', e => {
                const card = e.target.closest('.project-card');
                const optionsBtn = e.target.closest('[data-action="options"]');
                if (optionsBtn) {
                    e.stopPropagation();
                    handleProjectOptions(card.dataset.projectId);
                } else if (card) {
                    activeProjectId = card.dataset.projectId;
                    sidebarMode = 'chapters';
                    activeItemId = null;
                    if (unsubscribes.items) unsubscribes.items();
                    renderView('editor');
                    loadItems();
                }
            });
        }
        
        function renderEditor() {
            const project = projects.find(p => p.id === activeProjectId);
            if (!project) {
                renderView('home');
                return;
            }
            appContainer.querySelector('#project-title-sidebar').textContent = project.name;
            toggleSidebar(window.innerWidth >= 768);
            updateSidebarUI();
            
            if (activeItemId) renderEditorPanel();
            else appContainer.querySelector('#editor-panel').innerHTML = `<div class="flex-1 flex items-center justify-center text-gray-500">왼쪽에서 항목을 선택해주세요.</div>`;

            autoSaveInterval = setInterval(handleAutoSave, 300000);
            setupEditorListeners();
        }
        
        // OPTIMIZED: Separated event listeners for the editor view
        function setupEditorListeners() {
            const editorContainer = appContainer.querySelector('#editor-container');
            if (!editorContainer) return;
            
            // Sidebar listeners
            editorContainer.querySelector('#home-btn')?.addEventListener('click', () => renderView('home'));
            editorContainer.querySelector('#editor-sidebar-toggle')?.addEventListener('click', () => toggleSidebar());
            editorContainer.querySelector('#mobile-overlay')?.addEventListener('click', () => toggleSidebar(false));

            editorContainer.querySelector('#new-item-buttons-container')?.addEventListener('click', e => {
                if (e.target.closest('#new-item-btn')) handleNewItem('chapter');
                if (e.target.closest('#new-folder-btn')) handleNewItem('folder');
            });
            
            editorContainer.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', () => {
                sidebarMode = btn.dataset.tab;
                activeItemId = null;
                updateSidebarUI();
                loadItems();
                renderEditorPanel();
            }));

            const itemList = editorContainer.querySelector('#item-list');
            itemList?.addEventListener('click', e => {
                const itemEl = e.target.closest('.list-item');
                if (!itemEl) return;
                
                const folderToggle = e.target.closest('[data-action="toggle-folder"]');
                const deleteBtn = e.target.closest('[data-action="delete-item"]');

                if (folderToggle) {
                    const folderId = itemEl.dataset.id;
                    if (collapsedFolders.has(folderId)) collapsedFolders.delete(folderId);
                    else collapsedFolders.add(folderId);
                    renderItemList();
                } else if (deleteBtn) {
                    handleDeleteItem(itemEl.dataset.id);
                } else {
                    activeItemId = itemEl.dataset.id;
                    if (window.innerWidth < 768) toggleSidebar(false);
                    renderItemList();
                    renderEditorPanel();
                }
            });
            addDragAndDropListeners(itemList);

            // Editor panel listeners (dynamically attached inside renderEditorPanel)
        }
        
        // OPTIMIZED: List is rendered from a pre-processed tree structure
        function renderItemList() {
            const listEl = appContainer.querySelector('#item-list');
            if (!listEl) return;
            listEl.innerHTML = '';
            
            let itemsToRender = sidebarMode === 'chapters' ? chapters : characters;

            if (sidebarMode !== 'chapters') {
                itemsToRender.forEach(char => listEl.appendChild(createItemElement(char)));
                return;
            }

            // OPTIMIZATION: Build tree once
            const tree = buildItemTree(itemsToRender);
            
            // Render from tree
            function renderNode(node, container) {
                container.appendChild(createItemElement(node));
                if (node.children && node.children.length > 0) {
                    const childrenContainer = container.lastChild.querySelector('.folder-children');
                    node.children.forEach(childNode => renderNode(childNode, childrenContainer));
                }
            }
            tree.forEach(rootNode => renderNode(rootNode, listEl));
        }

        // OPTIMIZATION: Helper function to build the hierarchy
        function buildItemTree(list) {
            const map = new Map(list.map(item => [item.id, { ...item, children: [] }]));
            const tree = [];
            for (const item of map.values()) {
                if (item.parentId && map.has(item.parentId)) {
                    map.get(item.parentId).children.push(item);
                } else {
                    tree.push(item);
                }
            }
            // Sort children within each node
            map.forEach(node => node.children.sort((a,b) => (a.order ?? 0) - (b.order ?? 0)));
            // Sort root nodes
            tree.sort((a,b) => (a.order ?? 0) - (b.order ?? 0));
            return tree;
        }

        function renderEditorPanel() {
            const editorPanel = appContainer.querySelector('#editor-panel');
            if (!editorPanel) return;
            const item = getItem(activeProjectId, activeItemId);

            if (!item || item.type === 'folder') {
                editorPanel.innerHTML = `<div class="flex-1 flex items-center justify-center text-gray-500">${item ? '폴더가 선택되었습니다.' : '항목을 선택해주세요.'}</div>`;
                return;
            }
            
            editorPanel.innerHTML = '';
            editorPanel.appendChild(document.getElementById('editor-panel-template').content.cloneNode(true));
            
            // ... (logic to fill title and content is the same)
            updateCharCount();
            
            // OPTIMIZED: Add event listeners for the newly created panel elements
            editorPanel.querySelector('#editor-title')?.addEventListener('input', handleEditorInput);
            editorPanel.querySelector('#editor-content')?.addEventListener('input', handleEditorInput);
            editorPanel.querySelector('#save-txt-btn')?.addEventListener('click', handleSaveTxt);
            editorPanel.querySelector('#save-drive-btn')?.addEventListener('click', handleSaveToDrive);
            editorPanel.querySelector('#copy-content-btn')?.addEventListener('click', handleCopyContent);
            editorPanel.querySelector('#version-history-btn')?.addEventListener('click', handleShowVersionHistory);
            editorPanel.querySelector('#char-count-container')?.addEventListener('click', () => {
                charCountMode = charCountMode === 'noSpecialChars' ? 'noSpaces' : 'noSpecialChars';
                updateCharCount();
            });
        }
        
        // ... Other functions (createProjectCard, createItemElement, updateSidebarUI, etc.) are mostly the same but use appContainer.querySelector ...
        
        // --- Handlers (Logic remains the same) ---
        function handleGoogleLogin() { /* ... */ }
        function handleLogout() { /* ... */ }
        function handleNewProject() { /* ... */ }
        function handleProjectOptions(projectId) { /* ... */ }
        function handleRenameProject(projectId) { /* ... */ }
        function handleDeleteProject(projectId) { /* ... */ }
        function handleNewItem(type, parentId = null) { /* ... */ }
        function handleDeleteItem(itemId) { /* ... */ }
        function handleEditorInput(e) { /* ... */ }
        function saveCurrentWork() { /* ... */ }
        function handleAutoSave() { /* ... */ }
        function showAutoSaveFeedback(message, isError) { /* ... */ }
        function handleShowVersionHistory() { /* ... */ }
        function handleCopyContent() { /* ... */ }
        function handleSaveTxt() { /* ... */ }
        function handleSaveToDrive() { /* ... */ }
        function addDragAndDropListeners(element) { /* ... */ }

        initialize();
    });
    </script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>


