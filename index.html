<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>소설 집필 프로그램</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script>
        /* --- Google Drive API 설정 --- */
        const GOOGLE_API_KEY = 'AIzaSyDwkLPHCcuwfULdakJu2zFRBmWRBV6c7_M'; // API 키
        const GOOGLE_CLIENT_ID = '1068512138562-1mkelsqf0ph0f4at9f2po780cvt47o3t.apps.googleusercontent.com'; // OAuth 2.0 클라이언트 ID
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        let gapiInited = false;
        let tokenClient;

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }
        async function initializeGapiClient() {
            await gapi.client.init({ apiKey: GOOGLE_API_KEY, discoveryDocs: DISCOVERY_DOCS });
            gapiInited = true;
        }
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
        }
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #121212; color: #e0e0e0; overflow-x: hidden; }
        .bg-main { background-color: #121212; } .bg-surface { background-color: #1e1e1e; } .bg-card { background-color: #2a2a2a; } .border-main { border-color: #3f3f46; } .accent { color: #bb86fc; } .accent-bg { background-color: #bb86fc; } .accent-hover:hover { background-color: #a763ff; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #1e1e1e; } ::-webkit-scrollbar-thumb { background: #424242; border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: #5a5a5a; }
        .project-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; } .project-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15); }
        .list-item.active { background-color: #37373d; } .list-item:not(.active):hover { background-color: #2a2a2a; } .list-item .action-btn { visibility: hidden; opacity: 0; transition: opacity 0.2s; } .list-item:hover .action-btn { visibility: visible; opacity: 1; }
        .dragging { opacity: 0.5; background-color: #37373d; }
        .drag-over-item { border-top: 2px solid #bb86fc; }
        .drag-over-folder { background-color: #3a3a4a !important; box-shadow: 0 0 0 2px #bb86fc; }
        .tab-btn.active { background-color: #37373d; }
        .list-item-folder { background-color: #252525; font-weight: 500; } .list-item-chapter.in-folder { padding-left: 2rem !important; } .folder-children { max-height: 1000px; transition: max-height 0.3s ease-in-out; overflow: hidden; } .folder-children.collapsed { max-height: 0; }
        .folder-toggle { transition: transform 0.2s; } .folder-toggle.collapsed { transform: rotate(-90deg); }
        #editor-container { position: relative; overflow-x: hidden; } #editor-sidebar { width: 224px; position: absolute; top: 0; left: 0; height: 100%; z-index: 40; transform: translateX(-100%); transition: transform 0.3s ease-in-out; will-change: transform; } #editor-main-content { flex: 1; transition: padding-left 0.3s ease-in-out; padding-left: 0; }
        #editor-container.sidebar-open #editor-sidebar { transform: translateX(0); } #mobile-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 30; transition: opacity 0.3s ease-in-out; }
        #editor-sidebar-toggle { position: fixed; top: 50%; left: 0; transform: translateY(-50%); z-index: 50; width: 24px; height: 48px; display: flex; align-items: center; justify-content: center; transition: transform 0.3s ease-in-out; border-radius: 0 8px 8px 0; }
        #editor-container.sidebar-open #editor-sidebar-toggle { transform: translate(224px, -50%); }
        .character-image-container { background-color: #1e1e1e; background-size: cover; background-position: center; }
        .character-image-overlay { transition: opacity 0.2s; }
        @media (max-width: 767px) { #editor-container.sidebar-open #editor-main-content { padding-left: 0 !important; } }
        @media (min-width: 768px) { #editor-container.sidebar-open #editor-main-content { padding-left: 224px; } }
    </style>
</head>
<body class="bg-main antialiased">
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div id="loading-content" class="text-center text-white">
            <svg class="animate-spin h-10 w-10 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="text-lg">인증 정보를 확인하는 중입니다...</p>
        </div>
    </div>
    <div id="app-container" class="h-screen w-screen"></div>

    <!-- TEMPLATES -->
    <template id="login-view-template">
        <div class="flex flex-col items-center justify-center h-full text-center p-4">
            <h1 class="text-4xl font-bold mb-2">나만의 작업실</h1>
            <p class="text-gray-400 mb-8">당신의 이야기를 펼쳐보세요.</p>
            <button id="google-login-btn" class="bg-white text-black font-bold py-3 px-6 rounded-lg flex items-center gap-3 transition-transform hover:scale-105">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"/><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.222 0-9.61-3.317-11.28-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.021 35.596 44 30.138 44 24c0-1.341-.138-2.65-.389-3.917z"/></svg>
                <span>Google 계정으로 시작하기</span>
            </button>
        </div>
    </template>
    <template id="home-view-template">
        <div class="p-4 sm:p-6 md:p-8 flex flex-col h-full">
            <header class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold">내 작업실</h1>
                    <p id="user-id-display" class="text-xs text-gray-500 mt-1 truncate" title="사용자 ID"></p>
                </div>
                <div id="user-profile-area" class="flex items-center gap-4"></div>
            </header>
            <main class="flex-grow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">최근 편집</h2>
                    <button id="new-project-btn" class="accent-bg accent-hover text-black font-bold py-2 px-5 rounded-lg transition-colors">+ 새 프로젝트</button>
                </div>
                <div id="project-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>
                <div id="no-projects-placeholder" class="hidden text-center py-16">
                    <h3 class="text-xl font-semibold text-gray-400">아직 작업이 없네요.</h3>
                    <p class="text-gray-500 mt-2">새 프로젝트를 만들어 당신의 이야기를 시작해보세요!</p>
                </div>
            </main>
        </div>
    </template>
    <template id="editor-view-template">
        <div id="editor-container" class="h-screen">
            <div id="mobile-overlay" class="hidden md:hidden"></div>
            <aside id="editor-sidebar" class="bg-surface flex flex-col border-r border-main flex-shrink-0">
                <div class="p-4 border-b border-main flex items-center gap-3">
                    <button id="home-btn" class="p-2 rounded-md hover:bg-card">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                    </button>
                    <h2 id="project-title-sidebar" class="text-lg font-bold truncate"></h2>
                </div>
                <div class="flex-grow flex flex-col min-h-0">
                    <div class="p-2 border-b border-main">
                        <div class="flex bg-card rounded-md">
                            <button data-tab="chapters" class="tab-btn flex-1 p-2 text-sm font-semibold rounded-md">회차</button>
                            <button data-tab="characters" class="tab-btn flex-1 p-2 text-sm font-semibold rounded-md">등장인물</button>
                        </div>
                    </div>
                    <div class="p-3 flex justify-between items-center">
                        <h3 id="list-title" class="font-semibold"></h3>
                        <div id="new-item-buttons-container" class="flex gap-2"></div>
                    </div>
                    <nav id="item-list" class="flex-grow overflow-y-auto px-2 pb-2"></nav>
                </div>
            </aside>
            <div id="editor-main-content" class="flex flex-col w-full h-full">
                <main id="editor-panel" class="flex-1 flex flex-col min-h-0"></main>
            </div>
            <button id="editor-sidebar-toggle" class="bg-card hover:bg-purple-800">
                <svg id="toggle-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
            </button>
        </div>
    </template>
    <template id="editor-panel-template">
        <header class="p-4 border-b border-main flex flex-col sm:flex-row sm:justify-end sm:items-center items-end gap-3 sm:gap-4">
            <span id="save-status" class="text-sm text-gray-500 transition-opacity duration-500 opacity-0 mr-auto"></span>
            <div id="char-count-container" class="text-sm cursor-pointer" title="클릭하여 모드 변경">
                <span id="char-count-label">공백/특문 제외</span>: <span id="char-count" class="font-bold">0</span>
            </div>
             <div class="flex gap-2 flex-wrap justify-end">
                <button id="copy-content-btn" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors">원고 복사</button>
                <button id="save-drive-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors">Google Drive에 백업</button>
                <button id="save-txt-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors">TXT 저장</button>
            </div>
        </header>
        <div class="flex-1 p-6 sm:p-8 overflow-y-auto">
            <div class="max-w-3xl mx-auto h-full flex flex-col">
                <input id="editor-title" type="text" placeholder="제목을 입력하세요" class="bg-transparent text-2xl font-bold outline-none mb-4 pb-2 border-b-2 border-transparent focus:border-main transition">
                <textarea id="editor-content" placeholder="이곳에 이야기를 펼쳐보세요..." class="w-full flex-grow bg-transparent text-lg resize-none outline-none leading-relaxed"></textarea>
            </div>
        </div>
    </template>
    <template id="character-editor-panel-template">
         <div class="flex-1 p-4 sm:p-6 md:p-8 overflow-y-auto">
            <div class="max-w-4xl mx-auto">
                <input id="character-name" type="text" placeholder="등장인물 이름" class="bg-transparent text-3xl font-bold outline-none mb-6 w-full pb-2 border-b-2 border-transparent focus:border-main transition">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1">
                        <div id="character-image-container" class="character-image-container w-full aspect-square rounded-lg flex items-center justify-center relative group cursor-pointer border-2 border-dashed border-gray-600 hover:border-purple-500 transition-colors">
                            <div id="character-image-overlay" class="character-image-overlay absolute inset-0 bg-black bg-opacity-50 flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-2 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                <span class="text-white font-semibold">이미지 변경</span>
                            </div>
                             <span id="character-image-placeholder" class="text-gray-500">이미지 추가</span>
                        </div>
                        <input type="file" id="image-upload-input" class="hidden" accept="image/*">
                        <div id="image-upload-progress" class="w-full bg-gray-700 rounded-full h-2.5 mt-4 hidden">
                            <div class="bg-purple-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="lg:col-span-2 space-y-6">
                        <div>
                            <label for="character-personality" class="block text-sm font-medium text-gray-400 mb-2">성격</label>
                            <textarea id="character-personality" rows="4" class="w-full bg-surface p-3 rounded-md outline-none focus:ring-2 focus:ring-purple-500 border-2 border-transparent transition" placeholder="자신감 넘치지만 때로는 무모함..."></textarea>
                        </div>
                        <div>
                            <label for="character-appearance" class="block text-sm font-medium text-gray-400 mb-2">외모</label>
                            <textarea id="character-appearance" rows="4" class="w-full bg-surface p-3 rounded-md outline-none focus:ring-2 focus:ring-purple-500 border-2 border-transparent transition" placeholder="검은 머리카락과 날카로운 눈매..."></textarea>
                        </div>
                        <div>
                            <label for="character-characteristics" class="block text-sm font-medium text-gray-400 mb-2">특징 및 기타</label>
                            <textarea id="character-characteristics" rows="4" class="w-full bg-surface p-3 rounded-md outline-none focus:ring-2 focus:ring-purple-500 border-2 border-transparent transition" placeholder="오른쪽 손목의 흉터, 특정 단어를 반복하는 말버릇..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>
    <template id="modal-template"><!-- unchanged --></template>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script>
    function showModal(options) { /* ... unchanged ... */ }
    function closeModal() { /* ... unchanged ... */ }

    document.addEventListener('DOMContentLoaded', () => {
        const appContainer = document.getElementById('app-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingContent = document.getElementById('loading-content');

        let db, auth, storage;
        let currentUserId = null;
        let currentUser = null;
        let unsubscribes = {};
        
        let projects = [];
        let chapters = [];
        let characters = [];

        let activeProjectId = null;
        let activeItemId = null;
        let sidebarMode = 'chapters';
        let charCountMode = 'noSpecialChars';
        let saveTimeouts = {};
        let collapsedFolders = new Set();

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify({
            apiKey: "AIzaSyDuXjdB4DuP2NFF_OeS6nEwhMu_7wGdDs4",
            authDomain: "novel-8d4ec.firebaseapp.com",
            projectId: "novel-8d4ec",
            storageBucket: "novel-8d4ec.appspot.com",
            messagingSenderId: "836560106988",
            appId: "1:836560106988:web:cf90872d7b09b9498ffcc9",
            measurementId: "G-83BZ35QVLC"
        });
        
        function initialize() {
            try {
                const firebaseConfig = JSON.parse(firebaseConfigStr);
                if (!firebaseConfig.projectId) throw new Error("'projectId'가 Firebase 설정에 없습니다.");
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                storage = firebase.storage();
                setupAuthListener();
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                loadingContent.innerHTML = `<div class="text-center text-red-400"><p class="text-lg font-bold">초기화 오류</p><p class="text-sm">${error.message}</p></div>`;
            }
        }

        // FIXED: Decoupled auth check from data loading to prevent hangs
        function setupAuthListener() {
            auth.onAuthStateChanged(user => {
                currentUser = user;
                if (user) {
                    currentUserId = user.uid;
                    // Render the main app shell immediately
                    renderView('home');
                    // Then start loading data in the background
                    loadProjects();
                } else {
                    // If no user, show login
                    currentUserId = null;
                    projects = [];
                    Object.values(unsubscribes).forEach(unsub => {
                        if (typeof unsub === 'function') unsub();
                    });
                    unsubscribes = {};
                    renderView('login');
                }
                // Hide loading screen once auth state is known, regardless of data loading state
                loadingOverlay.style.display = 'none';
            });
        }

        // --- Data Loading & State ---
        function getProject(projectId) { return projects.find(p => p.id === projectId); }
        function getItem(itemId) {
            const items = sidebarMode === 'chapters' ? chapters : characters;
            return items.find(i => i.id === itemId);
        }

        function loadProjects() {
            if (!currentUserId) return;
            const projectsRef = db.collection(`artifacts/${appId}/users/${currentUserId}/projects`).orderBy('lastModified', 'desc');
            
            unsubscribes.projects = projectsRef.onSnapshot(snapshot => {
                projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Data has arrived, just update the project grid, don't re-render the whole view
                renderProjectGrid(); 
            }, error => {
                console.error("Project Loading Error:", error);
                const placeholder = appContainer.querySelector('#no-projects-placeholder');
                if(placeholder) {
                    placeholder.innerHTML = `<h3 class="text-xl font-semibold text-red-400">데이터 로딩 오류</h3><p class="text-gray-500 mt-2">프로젝트를 불러오지 못했습니다. Firestore 규칙을 확인해주세요.</p>`;
                    placeholder.classList.remove('hidden');
                }
            });
        }

        function loadItems() {
            if (unsubscribes.items) unsubscribes.items();
            const itemsRef = db.collection(`artifacts/${appId}/users/${currentUserId}/projects/${activeProjectId}/${sidebarMode}`);
            const q = itemsRef.orderBy(sidebarMode === 'chapters' ? 'order' : 'createdAt', 'asc');
            
            unsubscribes.items = q.onSnapshot(snapshot => {
                const itemList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (sidebarMode === 'chapters') {
                    chapters = itemList;
                } else {
                    characters = itemList;
                }
                renderItemList();
            });
        }

        // --- View Rendering & Listeners ---
        function renderView(viewName) {
            const template = document.getElementById(`${viewName}-view-template`);
            if (!template) return;
            appContainer.innerHTML = '';
            appContainer.appendChild(template.content.cloneNode(true));
            
            if (viewName === 'login') setupLoginListeners();
            else if (viewName === 'home') renderHome();
            else if (viewName === 'editor') renderEditor();
        }

        function setupLoginListeners() {
            appContainer.querySelector('#google-login-btn')?.addEventListener('click', handleGoogleLogin);
        }

        function renderHome() {
            const userProfileArea = appContainer.querySelector('#user-profile-area');
            if (currentUser) {
                userProfileArea.innerHTML = `
                    <div class="text-right">
                        <span class="font-semibold text-sm hidden sm:inline">${currentUser.displayName || '사용자'}</span>
                        <p class="text-xs text-gray-400 hidden sm:block truncate">${currentUser.email || '이메일 정보 없음'}</p>
                    </div>
                    <img class="w-10 h-10 rounded-full" src="${currentUser.photoURL || 'https://placehold.co/40x40/2a2a2a/e0e0e0?text=?'}" alt="Profile">
                    <button id="logout-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors">로그아웃</button>
                `;
            }
            renderProjectGrid();
            setupHomeListeners();
        }

        function renderProjectGrid() {
            const projectGrid = appContainer.querySelector('#project-grid');
            const placeholder = appContainer.querySelector('#no-projects-placeholder');
            if (!projectGrid || !placeholder) return; 

            if (projects.length === 0) {
                projectGrid.innerHTML = '';
                projectGrid.classList.add('hidden');
                placeholder.classList.remove('hidden');
            } else {
                projectGrid.classList.remove('hidden');
                placeholder.classList.add('hidden');
                projectGrid.innerHTML = '';
                projects.forEach(project => projectGrid.appendChild(createProjectCard(project)));
            }
        }

        function createProjectCard(project) { /* ... unchanged ... */ }
        function setupHomeListeners() { /* ... unchanged ... */ }
        function renderEditor() { /* ... unchanged ... */ }
        function setupEditorListeners() { /* ... unchanged ... */ }
        function renderItemList() { /* ... unchanged ... */ }
        function buildItemTree(list) { /* ... unchanged ... */ }
        function createItemElement(item) { /* ... unchanged ... */ }
        function renderEditorPanel() { /* ... unchanged ... */ }
        function setupChapterPanelListeners(panel) { /* ... unchanged ... */ }
        function setupCharacterPanelListeners(panel) { /* ... unchanged ... */ }
        function updateSidebarUI() { /* ... unchanged ... */ }
        function updateCharCount() { /* ... unchanged ... */ }
        function toggleSidebar(forceOpen) { /* ... unchanged ... */ }
        function updateSidebarVisuals() { /* ... unchanged ... */ }
        
        // --- Handlers ---
        function handleGoogleLogin() { /* ... unchanged ... */ }
        function handleLogout() { /* ... unchanged ... */ }
        function handleNewProject() { /* ... unchanged ... */ }
        function handleProjectOptions(projectId) { /* ... unchanged ... */ }
        function handleRenameProject(projectId) { /* ... unchanged ... */ }
        function handleDeleteProject(projectId) { /* ... unchanged ... */ }
        function handleNewItem(type, parentId = null) { /* ... unchanged ... */ }
        function handleDeleteItem(itemId) { /* ... unchanged ... */ }
        function handleRenameItem(itemId) { /* ... unchanged ... */ }
        function handleEditorInput(e) { /* ... unchanged ... */ }
        function saveCurrentWork() { /* ... unchanged ... */ }
        function handleCopyContent() { /* ... unchanged ... */ }
        function handleSaveTxt() { /* ... unchanged ... */ }
        async function handleSaveToDrive() { /* ... unchanged ... */ }
        function addDragAndDropListeners(listEl) { /* ... unchanged ... */ }
        function handleImageUpload(e) { /* ... unchanged ... */ }

        initialize();
    });
    </script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
