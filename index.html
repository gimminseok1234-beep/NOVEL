<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>소설 집필 프로그램 v2.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script>
        // These flags will be checked by the App once it's ready.
        let gapiInited = false;
        let gisInited = false;

        function gapiLoaded() {
            gapi.load('client', () => {
                gapiInited = true;
                window.App?.handlers.checkApisAndEnableLogin();
            });
        }
        function gisLoadinged() {
            gisInited = true;
            window.App?.handlers.checkApisAndEnableLogin();
        }
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <style>
        :root {
            --bg-main: #121212; --bg-surface: #1e1e1e; --bg-card: #2a2a2a; --bg-hover: #37373d;
            --border-main: #3f3f46; --text-main: #e0e0e0; --text-secondary: #a0a0a0;
            --accent-primary: #bb86fc; --accent-secondary: #a763ff; --accent-text: #000000;
        }
        [data-theme="light"] {
            --bg-main: #f4f7fc; --bg-surface: #ffffff; --bg-card: #ffffff; --bg-hover: #eef2f9;
            --border-main: #dce4f2; --text-main: #1a202c; --text-secondary: #718096;
            --accent-primary: #4299e1; --accent-secondary: #2b6cb0; --accent-text: #ffffff;
        }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--bg-main); color: var(--text-main); overflow-x: hidden; }
        .bg-main { background-color: var(--bg-main); } .bg-surface { background-color: var(--bg-surface); } .bg-card { background-color: var(--bg-card); } 
        .text-main { color: var(--text-main); } .text-secondary { color: var(--text-secondary); } .border-main { border-color: var(--border-main); } 
        .accent-bg { background-color: var(--accent-primary); color: var(--accent-text); } .accent-hover:hover { background-color: var(--accent-secondary); }
        .project-card { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        [data-theme="dark"] .project-card { box-shadow: none; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: var(--bg-surface); } ::-webkit-scrollbar-thumb { background: #424242; border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: #5a5a5a; }
        .list-item.active { background-color: var(--bg-hover); } .list-item:not(.active):hover { background-color: var(--bg-hover); } .list-item .action-btn { visibility: hidden; opacity: 0; transition: opacity 0.2s; } .list-item:hover .action-btn { visibility: visible; opacity: 1; }
        .dragging { opacity: 0.5; background-color: var(--bg-hover); }
        .drag-over-item { border-top: 2px solid var(--accent-primary); }
        .drag-over-folder { background-color: var(--bg-hover) !important; box-shadow: 0 0 0 2px var(--accent-primary); }
        .tab-btn.active { background-color: var(--bg-hover); }
        .list-item-folder { font-weight: 500; } 
        [data-theme="dark"] .list-item-folder { background-color: transparent; }
        .folder-children { max-height: 1000px; transition: max-height 0.3s ease-in-out; overflow: hidden; } .folder-children.collapsed { max-height: 0; }
        .folder-toggle { transition: transform 0.2s; } .folder-toggle.collapsed { transform: rotate(-90deg); }
        #editor-container { position: relative; overflow-x: hidden; } #editor-sidebar { width: 224px; position: absolute; top: 0; left: 0; height: 100%; z-index: 40; transform: translateX(-100%); transition: transform 0.3s ease-in-out; will-change: transform; } #editor-main-content { flex: 1; transition: padding-left 0.3s ease-in-out; padding-left: 0; }
        #editor-container.sidebar-open #editor-sidebar { transform: translateX(0); } #mobile-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 30; transition: opacity 0.3s ease-in-out; }
        #editor-sidebar-toggle { position: fixed; top: 50%; left: 0; transform: translateY(-50%); z-index: 50; width: 24px; height: 48px; display: flex; align-items: center; justify-content: center; transition: transform 0.3s ease-in-out; border-radius: 0 8px 8px 0; }
        #editor-container.sidebar-open #editor-sidebar-toggle { transform: translate(224px, -50%); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: var(--border-main); border-radius: 5px; }
        input[type=range]::-moz-range-track { width: 100%; height: 4px; cursor: pointer; background: var(--border-main); border-radius: 5px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: var(--accent-primary); cursor: pointer; margin-top: -6px; }
        input[type=range]::-moz-range-thumb { height: 16px; width: 16px; border-radius: 50%; background: var(--accent-primary); cursor: pointer; }
        [data-theme="light"] input[type=range]::-webkit-slider-runnable-track { background: #a0aec0; }
        [data-theme="light"] input[type=range]::-moz-range-track { background: #a0aec0; }
        #toast-container { position: fixed; bottom: 1rem; right: 1rem; z-index: 100; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { background-color: var(--bg-card); color: var(--text-main); padding: 0.75rem 1.25rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); border: 1px solid var(--border-main); animation: toast-in 0.5s, toast-out 0.5s 2.5s; }
        @keyframes toast-in { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes toast-out { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        @media (max-width: 767px) { #editor-container.sidebar-open #editor-main-content { padding-left: 0 !important; } }
        @media (min-width: 768px) { #editor-container.sidebar-open #editor-main-content { padding-left: 224px; } }
    </style>
</head>
<body class="bg-main text-main">
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div id="loading-content" class="text-center text-white">
            <svg class="animate-spin h-10 w-10 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="text-lg">인증 정보를 확인하는 중입니다...</p>
        </div>
    </div>
    <div id="app-container" class="h-screen w-screen"></div>
    <div id="toast-container"></div>

    <template id="login-view-template">
        <div class="flex flex-col items-center justify-center h-full text-center p-4">
            <h1 class="text-4xl font-bold">나만의 작업실</h1>
            <p class="text-gray-400 mb-8">당신의 이야기를 펼쳐보세요.</p>
            <button data-action="google-login" class="bg-white text-black font-bold py-3 px-6 rounded-lg flex items-center gap-3 transition-transform hover:scale-105" disabled>
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"/><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.222 0-9.61-3.317-11.28-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.021 35.596 44 30.138 44 24c0-1.341-.138-2.65-.389-3.917z"/></svg>
                <span id="google-login-btn-text">준비 중...</span>
            </button>
        </div>
    </template>

    <template id="home-view-template">
        <div class="p-4 sm:p-6 md:p-8 flex flex-col h-full">
            <header class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold">내 작업실</h1>
                </div>
                <div id="user-profile-area" class="flex items-center gap-4"></div>
            </header>
            <main class="flex-grow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">최근 편집</h2>
                    <button data-action="new-project" class="accent-bg accent-hover font-bold py-2 px-5 rounded-lg transition-colors">+ 새 프로젝트</button>
                </div>
                <div id="project-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>
                <div id="no-projects-placeholder" class="hidden text-center py-16">
                    <h3 class="text-xl font-semibold text-secondary">아직 작업이 없네요.</h3>
                    <p class="text-secondary mt-2">새 프로젝트를 만들어 당신의 이야기를 시작해보세요!</p>
                </div>
            </main>
        </div>
    </template>

    <template id="settings-view-template">
        <div class="p-4 sm:p-6 md:p-8 flex flex-col h-full">
            <header class="flex items-center mb-8">
                <button data-action="go-to-home" class="p-2 rounded-full hover:bg-hover mr-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                </button>
                <h1 class="text-3xl font-bold">설정</h1>
            </header>
            <main class="max-w-2xl mx-auto w-full space-y-8">
                <div class="bg-card p-6 rounded-lg">
                    <h2 class="text-xl font-semibold mb-4">테마 설정</h2>
                    <div class="flex gap-4">
                        <button data-action="set-theme" data-theme-value="dark" class="flex-1 p-4 rounded-md border-2 border-transparent text-center">
                            <div class="w-full h-16 bg-[#121212] rounded-md border-2 border-[#3f3f46] mb-2 pointer-events-none"></div>
                            <span class="font-semibold pointer-events-none">다크 테마</span>
                        </button>
                        <button data-action="set-theme" data-theme-value="light" class="flex-1 p-4 rounded-md border-2 border-transparent text-center">
                             <div class="w-full h-16 bg-[#f4f7fc] rounded-md border-2 border-[#dce4f2] mb-2 pointer-events-none"></div>
                            <span class="font-semibold pointer-events-none">라이트 테마</span>
                        </button>
                    </div>
                </div>
                <div class="bg-card p-6 rounded-lg">
                    <h2 class="text-xl font-semibold mb-4">에디터 너비 설정</h2>
                    <div class="flex items-center gap-4">
                        <input id="editor-width-slider" type="range" min="300" max="900" step="10" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                        <span id="editor-width-value" class="font-semibold w-16 text-center"></span>
                        <button data-action="reset-editor-width" class="text-sm bg-surface hover:bg-hover px-3 py-1 rounded-md border border-main">기본값</button>
                    </div>
                </div>
                <div class="bg-card p-6 rounded-lg">
                    <h2 class="text-xl font-semibold mb-4">Google Drive 연동</h2>
                    <div id="drive-status-area"></div>
                </div>
            </main>
        </div>
    </template>

    <template id="editor-view-template">
        <div id="editor-container" class="h-screen">
            <div data-action="toggle-sidebar" id="mobile-overlay" class="hidden md:hidden"></div>
            <aside id="editor-sidebar" class="bg-surface flex flex-col border-r border-main flex-shrink-0">
                <div class="p-4 border-b border-main flex items-center gap-3">
                    <button data-action="go-to-home" class="p-2 rounded-md hover:bg-card">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                    </button>
                    <h2 id="project-title-sidebar" class="text-lg font-bold truncate"></h2>
                </div>
                <div class="flex-grow flex flex-col min-h-0">
                    <div class="p-2 border-b border-main">
                        <div class="flex bg-card rounded-md">
                            <button data-action="switch-tab" data-tab-value="chapters" class="tab-btn flex-1 p-2 text-sm font-semibold rounded-md">회차</button>
                            <button data-action="switch-tab" data-tab-value="characters" class="tab-btn flex-1 p-2 text-sm font-semibold rounded-md">등장인물</button>
                        </div>
                    </div>
                    <div class="p-3 flex justify-between items-center">
                        <h3 id="list-title" class="font-semibold"></h3>
                        <div id="new-item-buttons-container" class="flex gap-2"></div>
                    </div>
                    <nav id="item-list" class="flex-grow overflow-y-auto px-2 pb-2"></nav>
                </div>
            </aside>
            <div id="editor-main-content" class="flex flex-col w-full h-full">
                <main id="editor-panel" class="flex-1 flex flex-col min-h-0"></main>
            </div>
            <button data-action="toggle-sidebar" id="editor-sidebar-toggle" class="bg-card hover:bg-purple-800">
                <svg id="toggle-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
            </button>
        </div>
    </template>

    <template id="editor-panel-template">
        <header class="p-4 border-b border-main flex flex-col sm:flex-row sm:justify-end sm:items-center items-end gap-3 sm:gap-4">
            <span id="save-status" class="text-sm text-secondary transition-opacity duration-500 opacity-0 mr-auto"></span>
            <div data-action="toggle-char-count-mode" id="char-count-container" class="text-sm cursor-pointer" title="클릭하여 모드 변경">
                <span id="char-count-label"></span>: <span id="char-count" class="font-bold">0</span>
            </div>
             <div class="flex gap-2 flex-wrap justify-end">
                <button data-action="copy-content" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors">원고 복사</button>
                <button data-action="save-to-drive" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors">Drive 백업</button>
                <button data-action="save-as-txt" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors">TXT 저장</button>
            </div>
        </header>
        <div class="flex-1 p-6 sm:p-8 overflow-y-auto">
            <div id="editor-content-wrapper" class="mx-auto h-full flex flex-col">
                <input id="editor-title" type="text" placeholder="제목을 입력하세요" class="bg-transparent text-2xl font-bold outline-none mb-4 pb-2 border-b-2 border-transparent focus:border-main transition">
                <textarea id="editor-content" placeholder="이곳에 이야기를 펼쳐보세요..." class="w-full flex-grow bg-transparent text-lg resize-none outline-none leading-relaxed"></textarea>
            </div>
        </div>
    </template>

    <template id="character-editor-panel-template">
         <div class="flex-1 p-4 sm:p-6 md:p-8 overflow-y-auto">
            <div class="max-w-4xl mx-auto">
                <input id="character-name" type="text" placeholder="등장인물 이름" class="bg-transparent text-3xl font-bold outline-none mb-6 w-full pb-2 border-b-2 border-transparent focus:border-main transition">
                <div class="space-y-6">
                    <div>
                        <label for="character-personality" class="block text-sm font-medium text-secondary mb-2">성격</label>
                        <textarea id="character-personality" rows="4" class="w-full bg-surface p-3 rounded-md outline-none focus:ring-2 focus:ring-accent-primary border-2 border-transparent transition" placeholder="자신감 넘치지만 때로는 무모함..."></textarea>
                    </div>
                    <div>
                        <label for="character-appearance" class="block text-sm font-medium text-secondary mb-2">외모</label>
                        <textarea id="character-appearance" rows="4" class="w-full bg-surface p-3 rounded-md outline-none focus:ring-2 focus:ring-accent-primary border-2 border-transparent transition" placeholder="검은 머리카락과 날카로운 눈매..."></textarea>
                    </div>
                    <div>
                        <label for="character-characteristics" class="block text-sm font-medium text-secondary mb-2">특징 및 기타</label>
                        <textarea id="character-characteristics" rows="8" class="w-full bg-surface p-3 rounded-md outline-none focus:ring-2 focus:ring-accent-primary border-2 border-transparent transition" placeholder="오른쪽 손목의 흉터, 특정 단어를 반복하는 말버릇..."></textarea>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="modal-template">
        <div id="modal-content" class="bg-card rounded-lg shadow-xl w-full max-w-md mx-4 p-6 flex flex-col gap-4">
            <h2 id="modal-title" class="text-2xl font-bold"></h2>
            <p id="modal-text" class="text-secondary"></p>
            <div id="modal-custom-content"></div>
            <input id="modal-input" type="text" class="hidden bg-surface p-2 rounded-md outline-none focus:ring-2 focus:ring-accent-primary border border-main">
            <div id="modal-buttons" class="flex justify-end gap-3 mt-2"></div>
        </div>
    </template>
    
    <template id="toast-template">
        <div class="toast"></div>
    </template>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
        const apiConfig = {
            GOOGLE_API_KEY: 'AIzaSyDwkLPHCcuwfULdakJu2zFRBmWRBV6c7_M',
            GOOGLE_CLIENT_ID: '1068512138562-1mkelsqf0ph0f4at9f2po780cvt47o3t.apps.googleusercontent.com',
            FIREBASE_CONFIG: {
                apiKey: "AIzaSyDuXjdB4DuP2NFF_OeS6nEwhMu_7wGdDs4",
                authDomain: "novel-8d4ec.firebaseapp.com",
                projectId: "novel-8d4ec",
                storageBucket: "novel-8d4ec.appspot.com",
                messagingSenderId: "836560106988",
                appId: "1:836560106988:web:cf90872d7b09b9498ffcc9"
            }
        };
        const appId = 'default-app-id'; // Simplified appId

        const App = {
            state: {
                db: null, auth: null, currentUser: null, gapiTokenClient: null,
                projects: [], chapters: [], characters: [],
                activeProjectId: null, activeItemId: null,
                sidebarMode: 'chapters', charCountMode: 'noSpecialChars', isSidebarOpen: false,
                saveTimeouts: {}, expandedFolders: new Set(),
                settings: { theme: 'dark', editorWidth: 370 },
                unsubscribes: {}
            },

            init() {
                window.App = this;
                this.db.initFirebase();
                
                document.addEventListener('DOMContentLoaded', () => {
                    this.view.loadSettings();
                    this.addEventListeners();
                    this.googleApi.initGapiClient();
                    this.handlers.checkApisAndEnableLogin(); // Check status on DOM ready
                });
            },

            addEventListeners() {
                const appContainer = document.getElementById('app-container');
                appContainer.addEventListener('click', e => {
                    const target = e.target.closest('[data-action]');
                    if (target && typeof this.handlers[target.dataset.action] === 'function') {
                        this.handlers[target.dataset.action].call(this.handlers, e);
                    }
                });
                appContainer.addEventListener('input', e => {
                    if (e.target.closest('#editor-title, #editor-content, #character-name, #character-personality, #character-appearance, #character-characteristics')) {
                        this.handlers.handleEditorInput(e);
                    }
                    if (e.target.id === 'editor-width-slider') {
                        this.handlers.handleEditorWidthChange(e);
                    }
                });
                appContainer.addEventListener('dragstart', this.handlers.handleDragStart.bind(this.handlers));
                appContainer.addEventListener('dragover', this.handlers.handleDragOver.bind(this.handlers));
                appContainer.addEventListener('dragleave', this.handlers.handleDragLeave.bind(this.handlers));
                appContainer.addEventListener('dragend', this.handlers.handleDragEnd.bind(this.handlers));
                appContainer.addEventListener('drop', this.handlers.handleDrop.bind(this.handlers));
            },

            db: {
                initFirebase() {
                    try {
                        firebase.initializeApp(apiConfig.FIREBASE_CONFIG);
                        App.state.db = firebase.firestore();
                        App.state.auth = firebase.auth();
                        App.state.auth.onAuthStateChanged(App.handlers.handleAuthStateChange);
                    } catch (error) {
                        console.error("Firebase Initialization Error:", error);
                        App.view.showLoadingError("Firebase 초기화 오류", error.message);
                    }
                }
            },

            googleApi: {
                initGapiClient() {
                    if (typeof gapi !== 'undefined' && typeof google !== 'undefined') {
                        gapi.client.init({
                            apiKey: apiConfig.GOOGLE_API_KEY,
                            discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
                        });
                        App.state.gapiTokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: apiConfig.GOOGLE_CLIENT_ID,
                            scope: 'https://www.googleapis.com/auth/drive.file',
                            callback: App.handlers.handleDriveTokenResponse,
                        });
                    } else {
                        console.error("Google API scripts not loaded yet.");
                    }
                }
            },

            view: {
                render(viewName, ...args) {
                    const template = document.getElementById(`${viewName}-view-template`);
                    if (!template) return;
                    const appContainer = document.getElementById('app-container');
                    appContainer.innerHTML = '';
                    appContainer.appendChild(template.content.cloneNode(true));
                    const renderFunc = this[`render${viewName.charAt(0).toUpperCase() + viewName.slice(1)}`];
                    if (typeof renderFunc === 'function') renderFunc.apply(this, args);
                },
                renderLogin() { App.handlers.checkApisAndEnableLogin(); },
                renderHome() { this.renderUserProfile(); this.renderProjectGrid(); },
                renderSettings() { this.updateThemeButtons(); this.updateEditorWidthSlider(); this.renderDriveStatus(); },
                renderEditor() {
                    const project = App.state.projects.find(p => p.id === App.state.activeProjectId);
                    if (!project) return this.render('home');
                    document.getElementById('project-title-sidebar').textContent = project.name;
                    this.toggleSidebar(window.innerWidth >= 768, true);
                    this.updateSidebarUI();
                    if (App.state.activeItemId) this.renderEditorPanel();
                    else document.getElementById('editor-panel').innerHTML = `<div class="flex-1 flex items-center justify-center text-secondary">왼쪽에서 항목을 선택해주세요.</div>`;
                },
                renderEditorPanel() {
                    const editorPanel = document.getElementById('editor-panel');
                    const items = App.state.sidebarMode === 'chapters' ? App.state.chapters : App.state.characters;
                    const item = items.find(i => i.id === App.state.activeItemId);
                    if (!editorPanel || !item || item.type === 'folder') {
                        editorPanel.innerHTML = `<div class="flex-1 flex items-center justify-center text-secondary">${item ? '폴더가 선택되었습니다.' : '항목을 선택해주세요.'}</div>`;
                        return;
                    }
                    const templateId = App.state.sidebarMode === 'chapters' ? 'editor-panel-template' : 'character-editor-panel-template';
                    editorPanel.innerHTML = '';
                    editorPanel.appendChild(document.getElementById(templateId).content.cloneNode(true));
                    if (App.state.sidebarMode === 'chapters') {
                        document.getElementById('editor-content-wrapper').style.maxWidth = `${App.state.settings.editorWidth}px`;
                        document.getElementById('editor-title').value = item.title || '';
                        document.getElementById('editor-content').value = item.content || '';
                    } else {
                        document.getElementById('character-name').value = item.name || '';
                        document.getElementById('character-personality').value = item.personality || '';
                        document.getElementById('character-appearance').value = item.appearance || '';
                        document.getElementById('character-characteristics').value = item.characteristics || '';
                    }
                    this.updateCharCount();
                },
                renderUserProfile() {
                    const area = document.getElementById('user-profile-area');
                    const user = App.state.currentUser;
                    if (!area || !user) return;
                    area.innerHTML = `
                        <button data-action="go-to-settings" class="p-2 rounded-full hover:bg-hover" title="설정">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-secondary pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        </button>
                        <div class="text-right">
                            <span class="font-semibold text-sm hidden sm:inline">${user.displayName || '사용자'}</span>
                            <p class="text-xs text-secondary hidden sm:block truncate">${user.email || ''}</p>
                        </div>
                        <img class="w-10 h-10 rounded-full" src="${user.photoURL || `https://placehold.co/40x40/${App.state.settings.theme === 'dark' ? '2a2a2a' : 'e0e0e0'}/e0e0e0?text=?`}" alt="Profile">
                        <button data-action="logout" class="bg-surface border border-main text-secondary font-bold py-2 px-4 rounded-lg text-sm transition-colors hover:bg-hover">로그아웃</button>
                    `;
                },
                renderProjectGrid() {
                    const grid = document.getElementById('project-grid');
                    const placeholder = document.getElementById('no-projects-placeholder');
                    if (!grid || !placeholder) return;
                    if (App.state.projects.length === 0) {
                        grid.innerHTML = ''; grid.classList.add('hidden'); placeholder.classList.remove('hidden');
                    } else {
                        grid.classList.remove('hidden'); placeholder.classList.add('hidden');
                        grid.innerHTML = App.state.projects.map(p => this.createProjectCard(p)).join('');
                    }
                },
                createProjectCard(project) {
                    const lastModified = project.lastModified ? new Date(project.lastModified.toMillis()).toLocaleString('ko-KR') : '날짜 정보 없음';
                    return `
                        <div class="project-card bg-card p-4 rounded-lg cursor-pointer flex flex-col h-48 border border-main" data-action="open-project" data-project-id="${project.id}">
                            <div class="flex-grow"><div class="flex justify-between items-start">
                                <h3 class="text-lg font-bold pointer-events-none">${project.name}</h3>
                                <button data-action="project-options" data-project-id="${project.id}" class="p-1 rounded-full hover:bg-surface -mr-1 -mt-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M6 10a2 2 0 11-4 0 2 2 0 014 0zM12 10a2 2 0 11-4 0 2 2 0 014 0zM16 12a2 2 0 100-4 2 2 0 000 4z" /></svg>
                                </button>
                            </div></div>
                            <div class="text-xs text-secondary pointer-events-none"><span>${lastModified} 수정됨</span></div>
                        </div>`;
                },
                renderItemList() {
                    const listEl = document.getElementById('item-list');
                    if (!listEl) return;
                    const itemsToRender = App.state.sidebarMode === 'chapters' ? App.state.chapters : App.state.characters;
                    if (App.state.sidebarMode !== 'chapters') {
                        listEl.innerHTML = itemsToRender.map(char => this.createItemElement(char)).join('');
                        return;
                    }
                    const tree = this.buildItemTree(itemsToRender);
                    const renderNode = (node) => {
                        let html = this.createItemElement(node);
                        if (node.children && node.children.length > 0) {
                            const childrenHtml = node.children.map(renderNode).join('');
                            const isCollapsed = !App.state.expandedFolders.has(node.id);
                            const childrenContainer = `<div class="folder-children pl-4 ${isCollapsed ? 'collapsed' : ''}">${childrenHtml}</div>`;
                            html = html.replace('</div>', childrenContainer + '</div>');
                        }
                        return html;
                    };
                    listEl.innerHTML = tree.map(renderNode).join('');
                },
                buildItemTree(list) {
                    const map = new Map(list.map(item => [item.id, { ...item, children: [] }]));
                    const tree = [];
                    for (const item of map.values()) {
                        if (item.parentId && map.has(item.parentId)) map.get(item.parentId).children.push(item);
                        else tree.push(item);
                    }
                    map.forEach(node => node.children.sort((a,b) => (a.order ?? 0) - (b.order ?? 0)));
                    tree.sort((a,b) => (a.order ?? 0) - (b.order ?? 0));
                    return tree;
                },
                createItemElement(item) {
                    const isFolder = item.type === 'folder';
                    const isExpanded = App.state.expandedFolders.has(item.id);
                    const isActive = item.id === App.state.activeItemId;
                    const folderIcons = `<svg data-action="toggle-folder" class="folder-toggle h-4 w-4 flex-shrink-0 ${!isExpanded ? 'collapsed' : ''}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg><svg class="h-4 w-4 text-yellow-400 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" /></svg>`;
                    const chapterIcon = `<svg class="h-4 w-4 text-secondary flex-shrink-0 ml-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A1 1 0 0111 2.586L15.414 7A1 1 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>`;
                    return `
                    <div class="list-item-wrapper" data-id="${item.id}" data-type="${isFolder ? 'folder' : 'chapter'}">
                        <div class="list-item p-2 px-3 rounded-md cursor-pointer text-sm flex justify-between items-center ${isActive ? 'active' : ''} ${isFolder ? 'list-item-folder' : ''}" draggable="true" data-action="select-item">
                            <div class="flex items-center gap-2 truncate flex-1 pointer-events-none">
                                ${isFolder ? folderIcons : chapterIcon}
                                <span class="truncate">${item.title || item.name}</span>
                            </div>
                            <div class="flex items-center">
                                ${isFolder ? `<button class="action-btn p-1 rounded-full hover:bg-blue-500/20" data-action="rename-item" title="이름 변경"><svg class="h-4 w-4 pointer-events-none text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>` : ''}
                                <button class="action-btn p-1 rounded-full hover:bg-red-500/20" data-action="delete-item" title="삭제"><svg class="h-4 w-4 pointer-events-none text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button>
                            </div>
                        </div></div>`;
                },
                async renderDriveStatus() {
                    const area = document.getElementById('drive-status-area');
                    if (!area) return;
                    const hasDriveScope = gapi.client.getToken() !== null;
                    if (hasDriveScope) {
                         try {
                            const response = await gapi.client.drive.about.get({ fields: 'user' });
                            const driveUser = response.result.user;
                            area.innerHTML = `
                                <div class="flex items-center gap-4">
                                    <img src="${driveUser.photoLink}" class="w-10 h-10 rounded-full" alt="Google User Photo">
                                    <div class="flex-grow">
                                        <p class="font-semibold">${driveUser.displayName}</p>
                                        <p class="text-sm text-secondary">${driveUser.emailAddress}</p>
                                    </div>
                                    <button data-action="drive-disconnect" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors">연결 해제</button>
                                </div>`;
                        } catch(e) {
                            console.error("Failed to get Drive user info:", e);
                            App.handlers.handleDriveDisconnect();
                        }
                    } else {
                        area.innerHTML = `
                            <div class="flex items-center justify-between">
                                <p class="text-secondary">Google Drive가 연결되지 않았습니다.</p>
                                <button data-action="drive-connect" class="accent-bg accent-hover font-bold py-2 px-4 rounded-lg text-sm transition-colors">연결하기</button>
                            </div>`;
                    }
                },
                updateSidebarUI() {
                    const container = document.getElementById('editor-container');
                    if (!container) return;
                    container.querySelectorAll('.tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.tabValue === App.state.sidebarMode));
                    const listTitle = container.querySelector('#list-title');
                    const newItemButtonsContainer = container.querySelector('#new-item-buttons-container');
                    if (App.state.sidebarMode === 'chapters') {
                        listTitle.textContent = '회차 목록';
                        newItemButtonsContainer.innerHTML = `
                            <button data-action="new-item" data-item-type="folder" title="새 폴더" class="accent-bg accent-hover p-2 rounded-md transition-colors">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" /></svg>
                            </button>
                            <button data-action="new-item" data-item-type="chapter" class="accent-bg accent-hover font-bold py-1 px-3 rounded-md transition-colors text-sm">+ 새 회차</button>`;
                    } else {
                        listTitle.textContent = '등장인물';
                        newItemButtonsContainer.innerHTML = `<button data-action="new-item" data-item-type="character" class="accent-bg accent-hover font-bold py-1 px-3 rounded-md transition-colors text-sm">+ 추가</button>`;
                    }
                },
                updateCharCount() {
                    const countEl = document.getElementById('char-count'), labelEl = document.getElementById('char-count-label');
                    if (!countEl || !labelEl) return;
                    const content = document.getElementById('editor-content')?.value || '';
                    let count = 0, label = '';
                    switch (App.state.charCountMode) {
                        case 'noSpaces': count = content.replace(/\s/g, '').length; label = '공백 제외'; break;
                        default: count = content.replace(/[.",'\s]/g, '').length; label = '공백/특문 제외'; break;
                    }
                    countEl.textContent = count.toLocaleString();
                    labelEl.textContent = label;
                },
                toggleSidebar(forceOpen, isInitial = false) {
                    const container = document.getElementById('editor-container');
                    if (!container) return;
                    const shouldBeOpen = typeof forceOpen !== 'undefined' ? forceOpen : !container.classList.contains('sidebar-open');
                    App.state.isSidebarOpen = shouldBeOpen;
                    container.classList.toggle('sidebar-open', shouldBeOpen);
                    if (!isInitial) this.updateSidebarVisuals();
                },
                updateSidebarVisuals() {
                    const container = document.getElementById('editor-container');
                    if (!container) return;
                    const overlay = container.querySelector('#mobile-overlay'), icon = container.querySelector('#toggle-icon');
                    const isOpen = App.state.isSidebarOpen;
                    overlay.classList.toggle('hidden', !isOpen || window.innerWidth >= 768);
                    icon.innerHTML = isOpen ? `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />` : `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />`;
                },
                showModal(options) {
                    this.closeModal();
                    const modalBackdrop = document.createElement('div');
                    modalBackdrop.id = 'modal-backdrop';
                    modalBackdrop.className = 'fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50';
                    const template = document.getElementById(options.templateId || 'modal-template').content.cloneNode(true);
                    modalBackdrop.appendChild(template);
                    modalBackdrop.addEventListener('click', e => { if (e.target.id === 'modal-backdrop' || e.target.closest('[data-action="close-modal"]')) this.closeModal(); });
                    const titleEl = modalBackdrop.querySelector('#modal-title');
                    if (titleEl && options.title) titleEl.textContent = options.title;
                    const textEl = modalBackdrop.querySelector('#modal-text');
                    if (textEl) { if (options.text) textEl.textContent = options.text; else textEl.style.display = 'none'; }
                    const inputEl = modalBackdrop.querySelector('#modal-input');
                    if (inputEl && options.inputPlaceholder) {
                        inputEl.classList.remove('hidden');
                        inputEl.placeholder = options.inputPlaceholder;
                        inputEl.value = options.initialValue || '';
                    }
                    const buttonsEl = modalBackdrop.querySelector('#modal-buttons');
                    if (buttonsEl && options.buttons) {
                        options.buttons.forEach(btnInfo => {
                            const button = document.createElement('button');
                            button.textContent = btnInfo.text;
                            button.className = btnInfo.class;
                            button.onclick = () => {
                                if (typeof btnInfo.onClick === 'function') btnInfo.onClick(inputEl ? inputEl.value : undefined);
                                if (btnInfo.closeOnClick !== false) this.closeModal();
                            };
                            buttonsEl.appendChild(button);
                        });
                    }
                    document.body.appendChild(modalBackdrop);
                    if(inputEl && options.inputPlaceholder) inputEl.focus();
                },
                closeModal() { document.getElementById('modal-backdrop')?.remove(); },
                showToast(message) {
                    const container = document.getElementById('toast-container');
                    const template = document.getElementById('toast-template');
                    if (!container || !template) return;
                    const toastEl = template.content.cloneNode(true).firstElementChild;
                    toastEl.textContent = message;
                    container.appendChild(toastEl);
                    setTimeout(() => toastEl.remove(), 3000);
                },
                showLoading(message) {
                    const overlay = document.getElementById('loading-overlay');
                    const text = overlay.querySelector('p');
                    overlay.style.display = 'flex';
                    if (text) text.textContent = message;
                },
                hideLoading() { document.getElementById('loading-overlay').style.display = 'none'; },
                showLoadingError(title, message) {
                    const content = document.getElementById('loading-content');
                    content.innerHTML = `<div class="text-center text-red-400"><p class="text-lg font-bold">${title}</p><p class="text-sm">${message}</p></div>`;
                },
                loadSettings() {
                    const saved = localStorage.getItem('novelWriterSettings');
                    if (saved) App.state.settings = { ...App.state.settings, ...JSON.parse(saved) };
                    this.applySettings();
                },
                saveSettings() { localStorage.setItem('novelWriterSettings', JSON.stringify(App.state.settings)); },
                applySettings() { document.body.dataset.theme = App.state.settings.theme; },
                updateThemeButtons() {
                    document.querySelectorAll('[data-action="set-theme"]').forEach(btn => {
                        const isSelected = btn.dataset.themeValue === App.state.settings.theme;
                        btn.classList.toggle('ring-2', isSelected);
                        btn.classList.toggle('ring-accent-primary', isSelected);
                    });
                },
                updateEditorWidthSlider() {
                    const slider = document.getElementById('editor-width-slider');
                    const valueEl = document.getElementById('editor-width-value');
                    if (!slider || !valueEl) return;
                    slider.value = App.state.settings.editorWidth;
                    valueEl.textContent = `${App.state.settings.editorWidth}px`;
                },
            },

            handlers: {
                checkApisAndEnableLogin() {
                    if (gapiInited && gisInited && window.App) {
                        const loginButton = document.querySelector('[data-action="google-login"]');
                        if (loginButton && loginButton.disabled) {
                            loginButton.disabled = false;
                            document.getElementById('google-login-btn-text').textContent = 'Google 계정으로 시작하기';
                        }
                    }
                },
                handleAuthStateChange(user) {
                    App.state.currentUser = user;
                    if (user) {
                        App.view.render('home');
                        App.handlers.loadProjects();
                    } else {
                        App.state.projects = [];
                        if (typeof gapi !== 'undefined' && gapi.client) gapi.client.setToken(null);
                        Object.values(App.state.unsubscribes).forEach(unsub => unsub?.());
                        App.state.unsubscribes = {};
                        App.view.render('login');
                    }
                    App.view.hideLoading();
                },
                googleLogin() {
                    App.view.showLoading('Google 계정으로 로그인 중...');
                    const provider = new firebase.auth.GoogleAuthProvider();
                    App.state.auth.signInWithPopup(provider).catch(error => {
                        console.error("Google Login Error:", error);
                        App.view.hideLoading();
                        App.view.showModal({title: "로그인 오류", text: error.message, buttons: [{text: '확인', class: 'px-4 py-2 accent-bg accent-hover rounded-md font-semibold'}]});
                    });
                },
                logout() { App.state.auth.signOut(); },
                goToHome() { App.view.render('home'); },
                goToSettings() { App.view.render('settings'); },
                loadProjects() {
                    if (!App.state.currentUser) return;
                    const ref = App.state.db.collection(`artifacts/${appId}/users/${App.state.currentUser.uid}/projects`);
                    App.state.unsubscribes.projects = ref.onSnapshot(snapshot => {
                        App.state.projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (b.lastModified?.toMillis() || 0) - (a.lastModified?.toMillis() || 0));
                        App.view.renderProjectGrid();
                    }, error => {
                        console.error("Project Loading Error:", error);
                        document.getElementById('no-projects-placeholder')?.innerHTML = `<h3 class="text-xl font-semibold text-red-400">데이터 로딩 오류</h3><p class="text-secondary mt-2">프로젝트를 불러오지 못했습니다.</p>`;
                    });
                },
                loadItems() {
                    App.state.unsubscribes.items?.();
                    const ref = App.state.db.collection(`artifacts/${appId}/users/${App.state.currentUser.uid}/projects/${App.state.activeProjectId}/${App.state.sidebarMode}`);
                    App.state.unsubscribes.items = ref.onSnapshot(snapshot => {
                        let itemList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        if (App.state.sidebarMode === 'chapters') App.state.chapters = itemList; // Sorting is handled by buildItemTree
                        else App.state.characters = itemList.sort((a, b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0));
                        App.view.renderItemList();
                    }, error => console.error(`Error loading ${App.state.sidebarMode}:`, error));
                },
                newProject() {
                    App.view.showModal({
                        title: '새 프로젝트 생성', text: '프로젝트 이름을 입력해주세요.', inputPlaceholder: '나의 멋진 소설',
                        buttons: [
                            { text: '취소', class: 'px-4 py-2 bg-surface hover:bg-hover rounded-md font-semibold' },
                            { text: '생성', class: 'px-4 py-2 accent-bg accent-hover rounded-md font-semibold', onClick: (name) => {
                                if (!name) return;
                                App.state.db.collection(`artifacts/${appId}/users/${App.state.currentUser.uid}/projects`).add({
                                    name: name,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    lastModified: firebase.firestore.FieldValue.serverTimestamp(),
                                });
                            }}
                        ]
                    });
                },
                openProject(e) {
                    App.state.activeProjectId = e.target.closest('[data-project-id]').dataset.projectId;
                    App.state.sidebarMode = 'chapters';
                    App.state.activeItemId = null;
                    App.state.expandedFolders = new Set();
                    App.state.unsubscribes.items?.();
                    App.view.render('editor');
                    this.loadItems();
                },
                projectOptions(e) {
                    e.stopPropagation();
                    const projectId = e.target.closest('[data-project-id]').dataset.projectId;
                    const project = App.state.projects.find(p => p.id === projectId);
                    App.view.showModal({
                        title: `'${project.name}' 설정`, text: '프로젝트 이름을 수정하거나 삭제할 수 있습니다.',
                        buttons: [
                            { text: '취소', class: 'px-4 py-2 bg-surface hover:bg-hover rounded-md font-semibold' },
                            { text: '이름 변경', class: 'px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-md font-semibold', onClick: () => setTimeout(() => this.renameProject(projectId), 10)},
                            { text: '삭제', class: 'px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-md font-semibold', onClick: () => setTimeout(() => this.deleteProject(projectId), 10)}
                        ]
                    });
                },
                renameProject(projectId) {
                    const project = App.state.projects.find(p => p.id === projectId);
                    App.view.showModal({
                        title: '이름 변경', text: `'${project.name}'의 새 이름을 입력하세요.`, inputPlaceholder: project.name, initialValue: project.name,
                        buttons: [
                            { text: '취소', class: 'px-4 py-2 bg-surface hover:bg-hover rounded-md font-semibold' },
                            { text: '저장', class: 'px-4 py-2 accent-bg accent-hover rounded-md font-semibold', onClick: (newName) => {
                                if (!newName) return;
                                App.state.db.collection(`artifacts/${appId}/users/${App.state.currentUser.uid}/projects`).doc(projectId).update({ name: newName, lastModified: firebase.firestore.FieldValue.serverTimestamp() });
                            }}
                        ]
                    });
                },
                deleteProject(projectId) {
                    const project = App.state.projects.find(p => p.id === projectId);
                    App.view.showModal({
                        title: `'${project.name}' 삭제`, text: '정말로 이 프로젝트를 삭제하시겠습니까? 되돌릴 수 없습니다.',
                        buttons: [
                            { text: '취소', class: 'px-4 py-2 bg-surface hover:bg-hover rounded-md font-semibold' },
                            { text: '삭제', class: 'px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-md font-semibold', onClick: () => {
                                App.state.db.collection(`artifacts/${appId}/users/${App.state.currentUser.uid}/projects`).doc(projectId).delete();
                            }}
                        ]
                    });
                },
                setTheme(e) {
                    App.state.settings.theme = e.target.dataset.themeValue;
                    App.view.saveSettings(); App.view.applySettings(); App.view.updateThemeButtons();
                },
                handleEditorWidthChange(e) {
                    App.state.settings.editorWidth = e.target.value;
                    App.view.saveSettings();
                    App.view.updateEditorWidthSlider();
                    const wrapper = document.getElementById('editor-content-wrapper');
                    if (wrapper) wrapper.style.maxWidth = `${App.state.settings.editorWidth}px`;
                },
                resetEditorWidth() {
                    App.state.settings.editorWidth = 370;
                    App.view.saveSettings();
                    App.view.updateEditorWidthSlider();
                    const wrapper = document.getElementById('editor-content-wrapper');
                    if (wrapper) wrapper.style.maxWidth = `370px`;
                },
                driveConnect() { App.state.gapiTokenClient.requestAccessToken({ prompt: 'consent' }); },
                handleDriveTokenResponse(res) {
                    if (res.error) { console.error("Google Drive Auth Error:", res.error); App.view.showToast("Google Drive 연결에 실패했습니다."); return; }
                    gapi.client.setToken(res);
                    App.view.renderDriveStatus(); App.view.showToast("Google Drive가 연결되었습니다.");
                },
                driveDisconnect() {
                    const token = gapi.client.getToken();
                    if (token) google.accounts.oauth2.revoke(token.access_token, () => {});
                    gapi.client.setToken(null);
                    App.view.renderDriveStatus(); App.view.showToast("Google Drive 연결이 해제되었습니다.");
                },
                toggleSidebar() { App.view.toggleSidebar(); },
                switchTab(e) {
                    App.state.sidebarMode = e.target.dataset.tabValue;
                    App.state.activeItemId = null;
                    App.view.updateSidebarUI(); this.loadItems(); App.view.renderEditorPanel();
                },
                newItem(e) {
                    const type = e.target.dataset.itemType;
                    const { db, currentUser, activeProjectId, sidebarMode, chapters } = App.state;
                    const collectionRef = db.collection(`artifacts/${appId}/users/${currentUser.uid}/projects/${activeProjectId}/${sidebarMode}`);
                    let newItemData;
                    if (sidebarMode === 'chapters') {
                        const siblings = chapters.filter(c => !c.parentId);
                        newItemData = { title: type === 'folder' ? '새 폴더' : '새 회차', type, parentId: null, order: siblings.length, createdAt: firebase.firestore.FieldValue.serverTimestamp(), ...(type === 'chapter' && { content: '' }) };
                    } else {
                        newItemData = { name: '새 등장인물', personality: '', appearance: '', characteristics: '', createdAt: firebase.firestore.FieldValue.serverTimestamp() };
                    }
                    collectionRef.add(newItemData).then(docRef => {
                        App.state.activeItemId = docRef.id;
                        db.collection(`artifacts/${appId}/users/${currentUser.uid}/projects`).doc(activeProjectId).update({ lastModified: firebase.firestore.FieldValue.serverTimestamp() });
                        App.view.renderItemList(); App.view.renderEditorPanel();
                    });
                },
                selectItem(e) {
                    const itemId = e.target.closest('[data-id]').dataset.id;
                    if (App.state.activeItemId === itemId) return;
                    App.state.activeItemId = itemId;
                    if (window.innerWidth < 768) App.view.toggleSidebar(false);
                    App.view.renderItemList(); App.view.renderEditorPanel();
                },
                toggleFolder(e) {
                    e.stopPropagation();
                    const folderId = e.target.closest('[data-id]').dataset.id;
                    if (App.state.expandedFolders.has(folderId)) App.state.expandedFolders.delete(folderId);
                    else App.state.expandedFolders.add(folderId);
                    App.view.renderItemList();
                },
                deleteItem(e) {
                    e.stopPropagation();
                    const itemId = e.target.closest('[data-id]').dataset.id;
                    const items = App.state.sidebarMode === 'chapters' ? App.state.chapters : App.state.characters;
                    const item = items.find(i => i.id === itemId);
                    const isFolder = item?.type === 'folder';
                    const itemType = isFolder ? '폴더' : (App.state.sidebarMode === 'chapters' ? '회차' : '등장인물');
                    let text = `정말로 이 ${itemType}를 삭제하시겠습니까?`;
                    if (isFolder) text += ' 폴더 안의 모든 회차도 함께 삭제됩니다.';
                    App.view.showModal({
                        title: `${itemType} 삭제`, text,
                        buttons: [
                            { text: '취소', class: 'px-4 py-2 bg-surface hover:bg-hover rounded-md font-semibold' },
                            { text: '삭제', class: 'px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-md font-semibold', onClick: async () => {
                                const { db, currentUser, activeProjectId, sidebarMode, chapters } = App.state;
                                const collectionRef = db.collection(`artifacts/${appId}/users/${currentUser.uid}/projects/${activeProjectId}/${sidebarMode}`);
                                const batch = db.batch();
                                if (isFolder) chapters.filter(c => c.parentId === itemId).forEach(child => batch.delete(collectionRef.doc(child.id)));
                                batch.delete(collectionRef.doc(itemId));
                                await batch.commit();
                                db.collection(`artifacts/${appId}/users/${currentUser.uid}/projects`).doc(activeProjectId).update({ lastModified: firebase.firestore.FieldValue.serverTimestamp() });
                                if (App.state.activeItemId === itemId) { App.state.activeItemId = null; App.view.renderEditorPanel(); }
                            }}
                        ]
                    });
                },
                renameItem(e) {
                    e.stopPropagation();
                    const itemId = e.target.closest('[data-id]').dataset.id;
                    const items = App.state.sidebarMode === 'chapters' ? App.state.chapters : App.state.characters;
                    const item = items.find(i => i.id === itemId);
                    const currentName = item.title || item.name;
                    App.view.showModal({
                        title: `'${currentName}' 이름 변경`, text: '새로운 이름을 입력하세요.', inputPlaceholder: currentName, initialValue: currentName,
                        buttons: [
                            { text: '취소', class: 'px-4 py-2 bg-surface hover:bg-hover rounded-md font-semibold' },
                            { text: '저장', class: 'px-4 py-2 accent-bg accent-hover rounded-md font-semibold', onClick: (newName) => {
                                if (!newName || newName === currentName) return;
                                const field = App.state.sidebarMode === 'chapters' ? 'title' : 'name';
                                App.state.db.collection(`artifacts/${appId}/users/${App.state.currentUser.uid}/projects/${App.state.activeProjectId}/${App.state.sidebarMode}`).doc(itemId).update({ [field]: newName });
                            }}
                        ]
                    });
                },
                handleEditorInput() {
                    App.view.updateCharCount();
                    const key = `${App.state.activeProjectId}-${App.state.activeItemId}`;
                    clearTimeout(App.state.saveTimeouts[key]);
                    App.state.saveTimeouts[key] = setTimeout(() => this.saveCurrentWork(), 500);
                },
                saveCurrentWork() {
                    const { activeProjectId, activeItemId, sidebarMode, db, currentUser } = App.state;
                    if (!activeProjectId || !activeItemId) return;
                    const items = sidebarMode === 'chapters' ? App.state.chapters : App.state.characters;
                    const item = items.find(i => i.id === activeItemId);
                    if (!item || item.type === 'folder') return;
                    
                    let data = {};
                    if (sidebarMode === 'chapters') {
                        data.title = document.getElementById('editor-title').value;
                        data.content = document.getElementById('editor-content').value;
                    } else {
                        data.name = document.getElementById('character-name').value;
                        data.personality = document.getElementById('character-personality').value;
                        data.appearance = document.getElementById('character-appearance').value;
                        data.characteristics = document.getElementById('character-characteristics').value;
                    }
                    db.collection(`artifacts/${appId}/users/${currentUser.uid}/projects/${activeProjectId}/${sidebarMode}`).doc(activeItemId).update(data);
                    db.collection(`artifacts/${appId}/users/${currentUser.uid}/projects`).doc(activeProjectId).update({ lastModified: firebase.firestore.FieldValue.serverTimestamp() });
                },
                copyContent() {
                    const contentEl = document.getElementById('editor-content');
                    if (!contentEl?.value) return;
                    navigator.clipboard.writeText(contentEl.value).then(() => App.view.showToast('✅ 원고가 복사되었습니다.')).catch(() => App.view.showToast('❌ 복사에 실패했습니다.'));
                },
                saveAsTxt() {
                    const { chapters, activeItemId, projects, activeProjectId } = App.state;
                    const item = chapters.find(c => c.id === activeItemId);
                    if (item && item.type !== 'folder') {
                        const project = projects.find(p => p.id === activeProjectId);
                        const content = `# ${item.title}\n\n${item.content}`;
                        const blob = new Blob([content], {type: 'text/plain;charset=utf-8'});
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        a.download = `[${project.name}] ${(item.title || '회차').replace(/[\/\\?%*:|"<>]/g, '-')}.txt`;
                        a.click();
                        URL.revokeObjectURL(a.href);
                    } else {
                        App.view.showModal({title: "알림", text: "회차를 선택해야 TXT 파일로 저장할 수 있습니다.", buttons: [{text: '확인', class: 'px-4 py-2 accent-bg accent-hover rounded-md font-semibold'}]});
                    }
                },
                async saveToDrive() {
                    if (!gapi.client.getToken()) {
                        App.view.showModal({ title: "Google Drive 연결 필요", text: "Google Drive에 백업하려면 먼저 설정에서 계정을 연결해주세요.", buttons: [{ text: '확인', class: 'px-4 py-2 accent-bg accent-hover rounded-md font-semibold'}]});
                        return;
                    }
                    const { chapters, activeItemId, projects, activeProjectId } = App.state;
                    const item = chapters.find(c => c.id === activeItemId);
                    if (!item || item.type === 'folder') {
                        App.view.showModal({title: "알림", text: "백업할 회차를 선택해주세요.", buttons: [{text: '확인', class: 'px-4 py-2 accent-bg accent-hover rounded-md font-semibold'}]});
                        return;
                    }
                    App.view.showToast('Google Drive에 백업하는 중...');
                    try {
                        const project = projects.find(p => p.id === activeProjectId);
                        const fileName = `[${project.name}] ${(item.title || '회차').replace(/[\/\\?%*:|"<>]/g, '-')}.txt`;
                        const fileContent = `# ${item.title}\n\n${item.content}`;
                        const fileMetadata = { 'name': fileName, 'mimeType': 'text/plain' };
                        const createResponse = await gapi.client.drive.files.create({ resource: fileMetadata, fields: 'id' });
                        const fileId = createResponse.result.id;
                        if (!fileId) throw new Error("파일 생성 실패");
                        await gapi.client.request({ path: `/upload/drive/v3/files/${fileId}`, method: 'PATCH', params: { uploadType: 'media' }, body: fileContent });
                        App.view.showToast('✅ Google Drive 백업 완료!');
                    } catch(err) {
                        console.error("Google Drive Save Error:", err);
                        App.view.showToast('❌ Google Drive 백업 실패');
                        if (err.result && (err.result.error.code === 401 || err.result.error.code === 403)) this.handleDriveDisconnect();
                    }
                },
                toggleCharCountMode() {
                    App.state.charCountMode = App.state.charCountMode === 'noSpecialChars' ? 'noSpaces' : 'noSpecialChars';
                    App.view.updateCharCount();
                },
                handleDragStart(e) {
                    if (App.state.sidebarMode !== 'chapters') return;
                    const target = e.target.closest('.list-item');
                    if (target) { this.draggedItemId = target.parentElement.dataset.id; setTimeout(() => target.classList.add('dragging'), 0); }
                },
                handleDragOver(e) {
                    if (!this.draggedItemId) return;
                    e.preventDefault();
                    document.querySelectorAll('.drag-over-item, .drag-over-folder').forEach(el => el.classList.remove('drag-over-item', 'drag-over-folder'));
                    const targetEl = e.target.closest('.list-item-wrapper');
                    if (targetEl && targetEl.dataset.id !== this.draggedItemId) {
                        if (targetEl.dataset.type === 'folder') targetEl.querySelector('.list-item').classList.add('drag-over-folder');
                        else targetEl.querySelector('.list-item').classList.add('drag-over-item');
                    }
                },
                handleDragLeave(e) { e.target.closest('.list-item')?.classList.remove('drag-over-item', 'drag-over-folder'); },
                handleDragEnd() {
                    this.draggedItemId = null;
                    document.querySelector('.dragging')?.classList.remove('dragging');
                    document.querySelectorAll('.drag-over-item, .drag-over-folder').forEach(el => el.classList.remove('drag-over-item', 'drag-over-folder'));
                },
                handleDrop(e) {
                    e.preventDefault();
                    if (!this.draggedItemId) return;
                    const { db, currentUser, activeProjectId, chapters } = App.state;
                    const collectionRef = db.collection(`artifacts/${appId}/users/${currentUser.uid}/projects/${activeProjectId}/chapters`);
                    
                    const draggedItem = chapters.find(c => c.id === this.draggedItemId);
                    if (!draggedItem) return;

                    const targetWrapper = e.target.closest('.list-item-wrapper');
                    let newParentId = null;
                    let targetOrder = 0;

                    if (targetWrapper) {
                        const targetItem = chapters.find(c => c.id === targetWrapper.dataset.id);
                        if (targetItem.type === 'folder') {
                            newParentId = targetItem.id;
                            targetOrder = chapters.filter(c => c.parentId === newParentId).length;
                        } else {
                            newParentId = targetItem.parentId || null;
                            targetOrder = targetItem.order;
                        }
                    } else {
                        newParentId = null;
                        targetOrder = chapters.filter(c => !c.parentId).length;
                    }
                    
                    if (draggedItem.id === newParentId) return; // Cannot drop into itself

                    const batch = db.batch();

                    // Reorder old siblings
                    const oldSiblings = chapters.filter(c => c.parentId === draggedItem.parentId && c.id !== draggedItem.id).sort((a, b) => a.order - b.order);
                    oldSiblings.forEach((item, index) => {
                        if (item.order !== index) batch.update(collectionRef.doc(item.id), { order: index });
                    });

                    // Update dragged item and reorder new siblings
                    const newSiblings = chapters.filter(c => c.parentId === newParentId && c.id !== draggedItem.id).sort((a, b) => a.order - b.order);
                    newSiblings.splice(targetOrder, 0, draggedItem);
                    newSiblings.forEach((item, index) => {
                        if (item.id === draggedItem.id) {
                            batch.update(collectionRef.doc(item.id), { order: index, parentId: newParentId });
                        } else if (item.order !== index) {
                            batch.update(collectionRef.doc(item.id), { order: index });
                        }
                    });

                    batch.commit().catch(err => console.error("Failed to reorder items:", err));
                }
            }
        };

        App.init();
    </script>
</body>
</html>
